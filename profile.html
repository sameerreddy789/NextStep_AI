<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | NextStep AI</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animated-background.css">
    <link rel="stylesheet" href="css/page-transitions.css">
    <link rel="stylesheet" href="css/celebration-modal.css">
    <link rel="stylesheet" href="css/profile-redesign.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (populated by sidebar.js) -->
        <aside class="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">My Profile</h1>
                <p class="page-subtitle">Manage your account information</p>
            </div>

            <div class="profile-layout">
                <!-- Left Column: Personal Side Card -->
                <aside class="profile-sidebar-card">
                    <div class="profile-avatar-large" id="profile-avatar">
                        <span id="avatar-initial">U</span>
                        <div class="avatar-upload-overlay" onclick="document.getElementById('avatar-input').click()">
                            <span>üì∑</span>
                        </div>
                        <button class="btn-remove-photo" id="btn-remove-photo" title="Remove Photo"
                            onclick="removeAvatar(event)">‚úï</button>
                    </div>
                    <input type="file" id="avatar-input" hidden accept="image/*" onchange="handleAvatarUpload(this)">
                    <h2 class="profile-name-main" id="profile-name">User Name</h2>
                    <div class="profile-role-badge" id="profile-role">Software Developer</div>

                    <ul class="profile-contact-list">
                        <li class="profile-contact-item">
                            <span>üìß</span>
                            <span id="view-email">john.doe@email.com</span>
                        </li>
                        <li class="profile-contact-item">
                            <span>üì±</span>
                            <span id="view-phone">+91 98765 43210</span>
                        </li>
                        <li class="profile-contact-item">
                            <span>üìç</span>
                            <span id="profile-location">Location not set</span>
                        </li>
                    </ul>



                    <button class="btn-edit-profile" onclick="toggleEdit('personal')">
                        <span>‚úèÔ∏è</span> Edit Profile
                    </button>

                    <button class="btn-logout-profile" onclick="logout()"
                        style="margin-top: 24px; margin-left: 0; width: 100%;">
                        <span>üö™</span> Logout
                    </button>
                </aside>

                <!-- Right Column: Insights and Heatmap -->
                <section class="profile-main-content">

                    <!-- 1Ô∏è‚É£ Profile Overview Card -->
                    <div class="insight-card">
                        <div class="overview-grid">
                            <div class="overview-item">
                                <span class="overview-label">Current Goal</span>
                                <div class="overview-value" id="view-role-alt">Software Developer</div>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Daily Time Spent</span>
                                <div class="overview-value">1h 30m</div>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Total Learning</span>
                                <div class="overview-value">124 hrs</div>
                            </div>
                        </div>
                    </div>

                    <!-- 2Ô∏è‚É£ Daily Streak Heatmap -->
                    <div class="insight-card streak-heatmap-section">
                        <div class="streak-header">
                            <h3><span class="flame-icon">üî•</span> Daily Learning Streak</h3>
                            <div class="streak-stats">
                                <span class="streak-badge">Current: 7 Days</span>
                                <span class="streak-badge orange">Max: 14 Days</span>
                                <span class="streak-badge">Total Active: 42 Days</span>
                            </div>
                        </div>
                        <div class="heatmap-container">
                            <div class="heatmap" id="heatmap">
                                <!-- Generated by JS -->
                            </div>
                            <div class="heatmap-legend">
                                <span>Less</span>
                                <div class="legend-box l0"></div>
                                <div class="legend-box l1"></div>
                                <div class="legend-box l2"></div>
                                <div class="legend-box l3"></div>
                                <div class="legend-box l4"></div>
                                <span>More</span>
                            </div>
                        </div>
                    </div>

                    <!-- 3Ô∏è‚É£ Progress Summary Cards -->
                    <div class="progress-row">
                        <div class="progress-mini-card">
                            <div class="mini-card-icon">üöÄ</div>
                            <div class="mini-card-info">
                                <h4>Roadmap Done</h4>
                                <div class="value">65%</div>
                            </div>
                        </div>
                        <div class="progress-mini-card">
                            <div class="mini-card-icon">ü§ù</div>
                            <div class="mini-card-info">
                                <h4>Interviews</h4>
                                <div class="value" id="stat-interviews-alt">3</div>
                            </div>
                        </div>
                        <div class="progress-mini-card">
                            <div class="mini-card-icon">üéØ</div>
                            <div class="mini-card-info">
                                <h4>Skills</h4>
                                <div class="value" id="stat-skills-alt">8</div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Media Links Showcase -->
                    <div class="insight-card social-showcase-section" id="social-showcase-card">
                        <div class="section-header-inline">
                            <h3 class="section-title">üîó Professional Profiles</h3>
                            <span class="section-subtitle-inline">Connect & Collaborate</span>
                        </div>
                        <div class="social-showcase-grid" id="social-showcase-grid">
                            <!-- LinkedIn Card -->
                            <a href="#" target="_blank" rel="noopener noreferrer"
                                class="social-showcase-card linkedin-card" id="linkedin-showcase">
                                <div class="showcase-card-inner">
                                    <div class="social-showcase-icon-large">
                                        <span class="showcase-icon-emoji">üîó</span>
                                    </div>
                                    <h4 class="social-showcase-title">LinkedIn</h4>
                                    <p class="social-showcase-action" id="linkedin-action">View Profile</p>
                                </div>
                            </a>
                            <!-- GitHub Card -->
                            <a href="#" target="_blank" rel="noopener noreferrer"
                                class="social-showcase-card github-card" id="github-showcase">
                                <div class="showcase-card-inner">
                                    <div class="social-showcase-icon-large">
                                        <span class="showcase-icon-emoji">üíª</span>
                                    </div>
                                    <h4 class="social-showcase-title">GitHub</h4>
                                    <p class="social-showcase-action" id="github-action">View Profile</p>
                                </div>
                            </a>
                            <!-- LeetCode Card -->
                            <a href="#" target="_blank" rel="noopener noreferrer"
                                class="social-showcase-card leetcode-card" id="leetcode-showcase">
                                <div class="showcase-card-inner">
                                    <div class="social-showcase-icon-large">
                                        <span class="showcase-icon-emoji">üß©</span>
                                    </div>
                                    <h4 class="social-showcase-title">LeetCode</h4>
                                    <p class="social-showcase-action" id="leetcode-action">View Profile</p>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Edit Mode (Hidden initially) -->
                    <div class="insight-card hidden" id="personal-edit">
                        <h3 class="section-title">Edit Personal Details</h3>
                        <div class="edit-form-container">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-input" id="edit-firstname" value="John">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-input" id="edit-lastname" value="Doe">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="edit-email" value="john.doe@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="edit-phone" value="+91 98765 43210">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Target Role</label>
                                <select class="form-select" id="edit-role">
                                    <option value="sde">Software Developer</option>
                                    <option value="frontend">Frontend Developer</option>
                                    <option value="backend">Backend Developer</option>
                                    <option value="fullstack">Full Stack Developer</option>
                                    <option value="data-analyst">Data Analyst</option>
                                    <option value="data-scientist">Data Scientist</option>
                                    <option value="ml-engineer">ML Engineer</option>
                                    <option value="devops">DevOps Engineer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-input" id="edit-dob" value="1998-06-15">
                            </div>

                            <!-- Social Media Links -->
                            <div class="form-group full-width">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <span>üîó</span> Professional Links
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">LinkedIn URL</label>
                                <input type="url" class="form-input social-input" id="edit-linkedin"
                                    placeholder="https://linkedin.com/in/yourprofile" data-platform="linkedin">
                                <div class="input-helper">Add your LinkedIn to showcase your professional background
                                </div>
                                <div class="input-validation" id="linkedin-validation"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">GitHub URL</label>
                                <input type="url" class="form-input social-input" id="edit-github"
                                    placeholder="https://github.com/yourusername" data-platform="github">
                                <div class="input-helper">Share your repositories and open-source contributions</div>
                                <div class="input-validation" id="github-validation"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">LeetCode URL</label>
                                <input type="url" class="form-input social-input" id="edit-leetcode"
                                    placeholder="https://leetcode.com/yourprofile" data-platform="leetcode">
                                <div class="input-helper">Highlight your coding practice and problem-solving skills
                                </div>
                                <div class="input-validation" id="leetcode-validation"></div>
                            </div>
                        </div>
                        <div class="edit-actions">
                            <button class="btn btn-secondary" onclick="toggleEdit('personal')">Cancel</button>
                            <button class="btn btn-primary" onclick="savePersonal()">Save Changes</button>
                        </div>
                    </div>

                </section>
            </div>
        </main>
    </div>

    <style>
        .profile-header-card {
            display: flex;
            align-items: center;
            gap: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .profile-avatar-section {
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            color: white;
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .btn-icon-sm {
            width: 32px;
            height: 32px;
            background: var(--accent-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 3px solid var(--bg-card);
            cursor: pointer;
        }

        .profile-header-info {
            flex: 1;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-role {
            font-size: 16px;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .profile-location {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .profile-stats-mini {
            display: flex;
            gap: 32px;
        }

        .btn-logout-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .btn-logout-profile:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .profile-stat-mini {
            text-align: center;
        }

        .stat-num {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .stat-lbl {
            font-size: 12px;
            color: var(--text-muted);
        }

        .profile-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .btn-edit {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            color: var(--accent-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-edit:hover {
            background: var(--accent-primary);
            color: white;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .profile-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-header-card {
                flex-direction: column;
                text-align: center;
            }

            .profile-stats-mini {
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        .profile-field label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-field span {
            font-size: 15px;
            font-weight: 500;
        }

        .edit-mode {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .edit-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
        }

        .danger-zone {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .danger-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .danger-content p {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* Heatmap Styles */
        .heatmap-container {
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .heatmap {
            display: grid;
            grid-template-rows: repeat(7, 12px);
            grid-auto-flow: column;
            gap: 4px;
            margin-bottom: 12px;
        }

        .day-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
        }

        .day-box.l0 {
            background: rgba(255, 255, 255, 0.05);
        }

        .day-box.l1 {
            background: rgba(16, 185, 129, 0.2);
        }

        .day-box.l2 {
            background: rgba(16, 185, 129, 0.4);
        }

        .day-box.l3 {
            background: rgba(16, 185, 129, 0.7);
        }

        .day-box.l4 {
            background: var(--accent-green);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
            justify-content: flex-end;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-box.l0 {
            background: rgba(255, 255, 255, 0.05);
        }

        .legend-box.l1 {
            background: rgba(16, 185, 129, 0.2);
        }

        .legend-box.l2 {
            background: rgba(16, 185, 129, 0.4);
        }

        .legend-box.l3 {
            background: rgba(16, 185, 129, 0.7);
        }

        .legend-box.l4 {
            background: var(--accent-green);
        }
    </style>

    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import ProfileService from './js/profile-service.js';

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadProfile(user.uid);
                    renderHeatmap();
                } else {
                    // Fallback to local storage or redirect
                    loadProfile();
                    renderHeatmap();
                }
            });
        });

        function renderHeatmap() {
            const heatmap = document.getElementById('heatmap');
            if (!heatmap) return;
            heatmap.innerHTML = '';

            const boxCount = 12 * 7; // 12 weeks
            const today = new Date();

            for (let i = boxCount - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);

                const day = document.createElement('div');
                day.className = 'day-box';

                // Random intensity (simulating data)
                const intensity = Math.random() > 0.7 ? Math.floor(Math.random() * 5) : 0;
                day.className += ` l${intensity}`;

                // Format date for tooltip
                const dateStr = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                day.title = `${dateStr}: ${intensity === 0 ? 'No activity' : intensity + ' level activity'}`;
                heatmap.appendChild(day);
            }
        }

        async function loadProfile(uid) {
            let profileData = null;
            if (uid) {
                profileData = await ProfileService.loadProfile(uid);
            }

            // Fallback to local storage if not in DB or no UID
            if (!profileData) {
                const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
                const extraProfile = JSON.parse(localStorage.getItem('nextStep_profile') || '{}');
                profileData = { ...userData, ...extraProfile };
            }

            // Populate UI
            if (profileData.name) {
                const nameParts = profileData.name.split(' ');
                document.getElementById('profile-name').textContent = profileData.name;
                document.getElementById('avatar-initial').textContent = profileData.name.charAt(0).toUpperCase();
                document.getElementById('edit-firstname').value = nameParts[0] || '';
                document.getElementById('edit-lastname').value = nameParts.slice(1).join(' ') || '';
            }

            if (profileData.email) {
                document.getElementById('view-email').textContent = profileData.email;
                document.getElementById('edit-email').value = profileData.email;
            }

            if (profileData.phone) {
                document.getElementById('view-phone').textContent = profileData.phone;
                document.getElementById('edit-phone').value = profileData.phone;
            }

            if (profileData.targetRole) {
                const roleNames = {
                    'sde': 'Software Developer',
                    'frontend': 'Frontend Developer',
                    'backend': 'Backend Developer',
                    'fullstack': 'Full Stack Developer',
                    'data-analyst': 'Data Analyst',
                    'data-scientist': 'Data Scientist',
                    'ml-engineer': 'ML Engineer',
                    'devops': 'DevOps Engineer',
                    'product': 'Product Manager',
                    'designer': 'UI/UX Designer'
                };
                const displayName = roleNames[profileData.targetRole] || profileData.targetRole;
                document.getElementById('profile-role').textContent = displayName;
                document.getElementById('view-role-alt').textContent = displayName;
                document.getElementById('edit-role').value = profileData.targetRole;
            }

            if (profileData.photoURL) {
                const avatarEl = document.getElementById('profile-avatar');
                avatarEl.style.backgroundImage = `url(${profileData.photoURL})`;
                document.getElementById('avatar-initial').style.display = 'none';
                document.getElementById('btn-remove-photo').style.display = 'flex';
            } else {
                document.getElementById('profile-avatar').style.backgroundImage = 'none';
                document.getElementById('avatar-initial').style.display = 'block';
                document.getElementById('btn-remove-photo').style.display = 'none';
            }

            if (profileData.location) {
                document.getElementById('profile-location').textContent = profileData.location;
            }

            // Load social media links
            loadSocialLinks(profileData.socialLinks || {});
        }

        function loadSocialLinks(socialLinks) {
            const platforms = ['linkedin', 'github', 'leetcode'];

            platforms.forEach(platform => {
                const linkData = socialLinks[platform];
                const editInputEl = document.getElementById(`edit-${platform}`);

                // Showcase elements (main content)
                const showcaseEl = document.getElementById(`${platform}-showcase`);
                const actionEl = document.getElementById(`${platform}-action`);

                if (linkData && linkData.url) {
                    // Populate edit field
                    if (editInputEl) editInputEl.value = linkData.url;

                    // Show/hide based on visibility
                    if (linkData.visible !== false) {
                        // Showcase - has link
                        if (showcaseEl) {
                            showcaseEl.href = linkData.url;
                            showcaseEl.classList.remove('empty-state');
                            showcaseEl.removeAttribute('onclick');
                        }
                        if (actionEl) {
                            actionEl.textContent = 'View Profile';
                        }
                    } else {
                        // Showcase - hidden link shows as empty
                        if (showcaseEl) {
                            showcaseEl.href = '#';
                            showcaseEl.classList.add('empty-state');
                            showcaseEl.setAttribute('onclick', 'window.toggleEdit(\'personal\'); return false;');
                        }
                        if (actionEl) {
                            actionEl.textContent = '+ Add Profile';
                        }
                    }
                } else {
                    // No URL set
                    if (editInputEl) editInputEl.value = '';

                    // Showcase - empty state
                    if (showcaseEl) {
                        showcaseEl.href = '#';
                        showcaseEl.classList.add('empty-state');
                        showcaseEl.setAttribute('onclick', 'window.toggleEdit(\'personal\'); return false;');
                    }
                    if (actionEl) {
                        actionEl.textContent = '+ Add Profile';
                    }
                }
            });

            // Always show showcase card
            const showcaseCard = document.getElementById('social-showcase-card');
            if (showcaseCard) {
                showcaseCard.style.display = 'block';
            }
        }

        window.validateURL = function (url, platform) {
            if (!url || url.trim() === '') {
                return { valid: true, message: '' }; // Empty is okay (optional)
            }

            // Basic URL validation
            try {
                const urlObj = new URL(url);

                // Platform-specific validation
                const platformPatterns = {
                    linkedin: /^https?:\/\/(www\.)?linkedin\.com\/(in|company)\/.+/i,
                    github: /^https?:\/\/(www\.)?github\.com\/.+/i,
                    leetcode: /^https?:\/\/(www\.)?leetcode\.com\/.+/i
                };

                if (platformPatterns[platform] && !platformPatterns[platform].test(url)) {
                    return {
                        valid: false,
                        message: `Please enter a valid ${platform.charAt(0).toUpperCase() + platform.slice(1)} URL`
                    };
                }

                return { valid: true, message: '‚úì Valid URL' };
            } catch (e) {
                return { valid: false, message: 'Please enter a valid URL' };
            }
        }

        window.toggleSocialVisibility = async function (platform) {
            const user = auth.currentUser;

            // Get current profile data
            let profileData = user ?
                await ProfileService.loadProfile(user.uid) :
                JSON.parse(localStorage.getItem('nextStep_profile') || '{}');

            const socialLinks = profileData.socialLinks || {};
            const linkData = socialLinks[platform] || {};

            // Toggle visibility
            linkData.visible = !(linkData.visible !== false); // Default true, so toggle

            // If no URL, can't toggle visibility
            if (!linkData.url) {
                showNotification(`Please add your ${platform} URL first!`);
                return;
            }

            // Update social links
            socialLinks[platform] = linkData;
            const dataToSave = { socialLinks };

            // Save
            if (user) {
                await ProfileService.saveProfile(user.uid, dataToSave);
            } else {
                const current = JSON.parse(localStorage.getItem('nextStep_profile') || '{}');
                current.socialLinks = socialLinks;
                localStorage.setItem('nextStep_profile', JSON.stringify(current));
                localStorage.setItem('nextStep_user', JSON.stringify(current));
            }

            // Update UI
            loadSocialLinks(socialLinks);
            showNotification(linkData.visible ?
                `${platform} link is now visible` :
                `${platform} link is now hidden`);
        }

        window.removeAvatar = async function (e) {
            e.stopPropagation(); // Prevent triggering the file input
            if (!confirm('Are you sure you want to remove your profile photo?')) return;

            const user = auth.currentUser;
            const data = { photoURL: null };

            if (user) {
                await ProfileService.saveProfile(user.uid, data);
            } else {
                const current = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
                current.photoURL = null;
                localStorage.setItem('nextStep_user', JSON.stringify(current));
                localStorage.setItem('nextStep_profile', JSON.stringify(current));
            }

            // Update UI
            document.getElementById('profile-avatar').style.backgroundImage = 'none';
            document.getElementById('avatar-initial').style.display = 'block';
            document.getElementById('btn-remove-photo').style.display = 'none';
            showNotification('Profile photo removed!');
        }

        window.handleAvatarUpload = function (input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (limit to 1MB for local storage)
            if (file.size > 1024 * 1024) {
                showNotification('Image too large! Please choose an image under 1MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function (e) {
                const photoURL = e.target.result;
                const avatarEl = document.getElementById('profile-avatar');
                avatarEl.style.backgroundImage = `url(${photoURL})`;
                document.getElementById('avatar-initial').style.display = 'none';
                document.getElementById('btn-remove-photo').style.display = 'flex';

                // Save to Firebase/LocalStorage
                const user = auth.currentUser;
                const data = { photoURL: photoURL };

                if (user) {
                    await ProfileService.saveProfile(user.uid, data);
                } else {
                    const current = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
                    const merged = { ...current, ...data };
                    localStorage.setItem('nextStep_user', JSON.stringify(merged));
                    localStorage.setItem('nextStep_profile', JSON.stringify(merged));
                }
                showNotification('Profile photo updated!');
            };
            reader.readAsDataURL(file);
        }

        window.toggleEdit = function (section) {
            const editEl = document.getElementById(`${section}-edit`);
            if (editEl) {
                editEl.classList.toggle('hidden');
                // Scroll to edit section if opening
                if (!editEl.classList.contains('hidden')) {
                    editEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        window.savePersonal = async function () {
            const user = auth.currentUser;
            const firstname = document.getElementById('edit-firstname').value;
            const lastname = document.getElementById('edit-lastname').value;
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
            const targetRole = document.getElementById('edit-role').value;

            // Validate and collect social media links
            const socialLinks = {};
            const platforms = ['linkedin', 'github', 'leetcode'];
            let hasValidationError = false;

            platforms.forEach(platform => {
                const inputEl = document.getElementById(`edit-${platform}`);
                const validationEl = document.getElementById(`${platform}-validation`);
                const url = inputEl ? inputEl.value.trim() : '';

                if (url) {
                    const validation = validateURL(url, platform);

                    if (!validation.valid) {
                        hasValidationError = true;
                        if (inputEl) inputEl.classList.add('invalid');
                        if (validationEl) {
                            validationEl.textContent = validation.message;
                            validationEl.classList.add('error');
                            validationEl.classList.remove('success');
                        }
                    } else {
                        if (inputEl) {
                            inputEl.classList.remove('invalid');
                            inputEl.classList.add('valid');
                        }
                        if (validationEl) {
                            validationEl.textContent = validation.message;
                            validationEl.classList.add('success');
                            validationEl.classList.remove('error');
                        }
                        socialLinks[platform] = { url, visible: true };
                    }
                } else {
                    // Clear validation styling
                    if (inputEl) {
                        inputEl.classList.remove('invalid', 'valid');
                    }
                    if (validationEl) {
                        validationEl.textContent = '';
                        validationEl.classList.remove('error', 'success');
                    }
                }
            });

            if (hasValidationError) {
                showNotification('Please fix the invalid URLs before saving.');
                return;
            }

            const data = {
                name: `${firstname} ${lastname}`.trim(),
                email: email,
                phone: phone,
                targetRole: targetRole,
                socialLinks: socialLinks
            };

            if (user) {
                await ProfileService.saveProfile(user.uid, data);
            } else {
                const current = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
                const merged = { ...current, ...data };
                localStorage.setItem('nextStep_user', JSON.stringify(merged));
                localStorage.setItem('nextStep_profile', JSON.stringify(merged));
            }

            // Update UI
            document.getElementById('view-email').textContent = email;
            document.getElementById('view-phone').textContent = phone;
            document.getElementById('profile-name').textContent = data.name;
            document.getElementById('avatar-initial').textContent = data.name.charAt(0).toUpperCase();

            const roleNames = {
                'sde': 'Software Developer',
                'frontend': 'Frontend Developer',
                'backend': 'Backend Developer',
                'fullstack': 'Full Stack Developer',
                'data-analyst': 'Data Analyst',
                'data-scientist': 'Data Scientist',
                'ml-engineer': 'ML Engineer',
                'devops': 'DevOps Engineer'
            };
            const roleDisplay = roleNames[targetRole] || targetRole;
            document.getElementById('profile-role').textContent = roleDisplay;
            document.getElementById('view-role-alt').textContent = roleDisplay;

            // Update social links view
            loadSocialLinks(socialLinks);

            window.toggleEdit('personal');
            if (window.UIUtils) window.UIUtils.showToast('Profile updated successfully!', 'success');

            // Refresh sidebar immediately
            if (window.SidebarComponent) window.SidebarComponent.generate();
        }

    </script>
    <script src="js/ui-utils.js"></script>
    <script src="js/sidebar.js" type="module"></script>
    <script src="js/click-spark.js"></script>
</body>

</html>