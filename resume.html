<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analysis | NextStep AI</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animated-background.css">
    <link rel="stylesheet" href="css/page-transitions.css">
    <link rel="stylesheet" href="css/celebration-modal.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="js/env-config.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/route-guard.js"></script>
    <script src="js/gemini-service.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (populated by sidebar.js) -->
        <aside class="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">üìÑ Resume Analysis</h1>
                <p class="page-subtitle">Upload your resume and let AI extract your skills and identify gaps</p>
            </div>

            <!-- Upload Zone (shown initially) -->
            <div id="upload-section">
                <!-- Important Information Card -->
                <div class="card mb-lg"
                    style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(99, 102, 241, 0.3);">
                    <div class="card-header">
                        <h3 class="card-title">üìã What Your Resume Should Include</h3>
                    </div>
                    <div style="padding: 0 24px 24px;">
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                            For accurate ATS scoring and skill gap analysis, make sure your resume contains:
                        </p>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div
                                style="padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                                <div
                                    style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: var(--accent-green);">
                                    ‚úÖ Required Sections</div>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.8;">
                                    <li><strong>Contact Info</strong> - Name, email, phone</li>
                                    <li><strong>Skills</strong> - Technical & soft skills</li>
                                    <li><strong>Experience</strong> - Job titles, companies, duration</li>
                                    <li><strong>Education</strong> - Degree, institution, year</li>
                                </ul>
                            </div>

                            <div
                                style="padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                                <div
                                    style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: var(--accent-primary);">
                                    üí° Recommended</div>
                                <ul
                                    style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.8;">
                                    <li><strong>Projects</strong> - Personal/academic projects</li>
                                    <li><strong>Certifications</strong> - Relevant credentials</li>
                                    <li><strong>Achievements</strong> - Quantifiable results</li>
                                    <li><strong>Keywords</strong> - Role-specific terms</li>
                                </ul>
                            </div>
                        </div>

                        <div
                            style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="display: flex; align-items: start; gap: 8px;">
                                <span style="font-size: 16px;">‚ö†Ô∏è</span>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    <strong>ATS-Friendly Tips:</strong> Use standard fonts, avoid images/graphics,
                                    include relevant keywords from your target role, and use clear section headings.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop your resume here</div>
                    <div class="upload-hint">or click to browse (PDF, DOC, DOCX)</div>
                    <input type="file" id="file-input" accept=".pdf,.doc,.docx" style="display: none;">
                </div>

            </div>

            <!-- Analysis Results (hidden initially) -->
            <div id="results-section" class="hidden">
                <!-- Resume Score -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15);">üìä</div>
                        <div>
                            <div class="stat-value" id="resume-score">0</div>
                            <div class="stat-label">Resume Score</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(99, 102, 241, 0.15);">üéØ</div>
                        <div>
                            <div class="stat-value" id="skill-coverage">0%</div>
                            <div class="stat-label">Skill Coverage</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.15);">‚ö†Ô∏è</div>
                        <div>
                            <div class="stat-value" id="missing-count">0</div>
                            <div class="stat-label">Missing Skills</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15);">üìà</div>
                        <div>
                            <div class="stat-value" id="readiness">0%</div>
                            <div class="stat-label">Job Readiness</div>
                        </div>
                    </div>
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05)); border-color: rgba(139, 92, 246, 0.3);">
                        <div class="stat-icon" style="background: rgba(139, 92, 246, 0.15);">ü§ñ</div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div class="stat-value" id="ats-score" style="color: var(--accent-purple);">0%</div>
                                <div class="ats-tooltip-container" id="ats-tooltip-container" style="display: none;">
                                    <span class="info-icon">‚ÑπÔ∏è</span>
                                    <div class="tooltip-content">
                                        <strong>ü§ñ What is ATS Score?</strong>
                                        <p>ATS (Applicant Tracking System) is software used by companies to screen
                                            resumes before they reach human recruiters.</p>
                                        <p><strong>Your ATS Score shows:</strong></p>
                                        <ul>
                                            <li>‚úÖ How well your resume matches job requirements</li>
                                            <li>üìù If it contains the right keywords</li>
                                            <li>üìã Whether the format is ATS-friendly</li>
                                        </ul>
                                        <p style="margin-top: 8px; font-size: 11px; color: var(--accent-green);">üí°
                                            <strong>Tip:</strong> 80%+ score means your resume will likely pass ATS
                                            screening!
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="stat-label">ATS Score</div>
                        </div>
                    </div>
                </div>

                <!-- ATS Score Breakdown -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">ü§ñ ATS Compatibility Analysis</h2>
                        <span class="badge" id="ats-badge">Analyzing...</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                            Your resume's compatibility with Applicant Tracking Systems (ATS) used by companies to
                            screen candidates.
                        </p>
                        <div class="progress-bar" style="height: 12px; margin-bottom: 8px;">
                            <div class="progress-fill" id="ats-progress" style="width: 0%; transition: width 1s ease;">
                            </div>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                            <span>Poor</span>
                            <span>Fair</span>
                            <span>Good</span>
                            <span>Excellent</span>
                        </div>
                    </div>

                    <!-- ATS Scoring Breakdown -->
                    <div class="ats-breakdown">
                        <div class="ats-criteria-item">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">üìù Keyword Match</span>
                                <span id="keyword-score"
                                    style="font-size: 14px; font-weight: 600; color: var(--accent-green);">0%</span>
                            </div>
                            <div class="progress-bar" style="height: 6px;">
                                <div class="progress-fill" id="keyword-progress" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="ats-criteria-item">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">üéì Experience Relevance</span>
                                <span id="experience-score"
                                    style="font-size: 14px; font-weight: 600; color: var(--accent-green);">0%</span>
                            </div>
                            <div class="progress-bar" style="height: 6px;">
                                <div class="progress-fill" id="experience-progress" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="ats-criteria-item">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">üìã Format Compatibility</span>
                                <span id="format-score"
                                    style="font-size: 14px; font-weight: 600; color: var(--accent-green);">0%</span>
                            </div>
                            <div class="progress-bar" style="height: 6px;">
                                <div class="progress-fill" id="format-progress" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ATS Improvement Suggestions -->
                    <div
                        style="margin-top: 24px; padding: 16px; background: rgba(139, 92, 246, 0.05); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <h3
                            style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: var(--accent-purple);">
                            üí° Improvement Suggestions</h3>
                        <ul id="ats-suggestions"
                            style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <!-- Suggestions will be injected here -->
                        </ul>
                    </div>
                </div>

                <!-- Skills Found -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">‚úÖ Skills Detected</h2>
                        <span class="badge badge-green" id="found-count">0 skills</span>
                    </div>
                    <div id="skills-found" class="skills-grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                        <!-- Skills will be injected here -->
                    </div>
                </div>

                <!-- Missing Skills -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">‚ùå Missing Critical Skills</h2>
                        <span class="badge badge-red" id="missing-badge">0 skills</span>
                    </div>
                    <div id="skills-missing" class="skills-grid"
                        style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                        <!-- Skills will be injected here -->
                    </div>
                </div>

                <!-- Projects & Experience -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 16px;">üíº Experience Detected</h3>
                        <div id="experience-list">
                            <!-- Experience will be injected here -->
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 16px;">üöÄ Projects Detected</h3>
                        <div id="projects-list">
                            <!-- Projects will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- CTA -->
                <div style="text-align: center; margin-top: 32px;">
                    <a href="interview.html" class="btn btn-primary btn-lg">
                        Start AI Interview ‚Üí
                    </a>
                </div>

                <!-- Re-upload Resume Option -->
                <div style="text-align: center; margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="reUploadResume()"
                        style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span> Re-upload Resume
                    </button>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                        Upload a new resume to update your skill analysis
                    </p>
                </div>
            </div>

            <!-- Analyzing State -->
            <div id="analyzing-section" class="hidden" style="text-align: center; padding: 80px 20px;">
                <div class="float" style="font-size: 64px; margin-bottom: 24px;">üîç</div>
                <h2 style="font-size: 24px; margin-bottom: 8px;">Analyzing Your Resume...</h2>
                <p class="text-muted">AI is extracting skills, projects, and experience</p>
                <div style="width: 200px; margin: 24px auto;">
                    <div class="progress-bar" style="height: 6px;">
                        <div class="progress-fill" id="analysis-progress"
                            style="width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        /* Smooth Hover Animations (Home/Profile Style) */
        .stat-icon,
        .upload-icon,
        .mini-card-icon,
        .info-icon,
        .skill-tag span:first-child {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: inline-flex;
        }

        .stat-card:hover .stat-icon,
        .upload-zone:hover .upload-icon,
        .skill-tag:hover span:first-child {
            transform: rotate(360deg) scale(1.2) !important;
        }

        .card,
        .stat-card,
        .upload-zone {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover,
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-primary) !important;
        }

        .upload-zone:hover {
            transform: scale(1.01);
            background: rgba(99, 102, 241, 0.05);
            border-color: var(--accent-primary);
        }

        /* Entry Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
            cursor: default;
        }

        .skill-tag:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .skill-tag.present {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .skill-tag.missing {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .skill-tag.partial {
            border-color: var(--accent-gold);
            background: rgba(245, 158, 11, 0.1);
        }

        .experience-item,
        .project-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .experience-item h4,
        .project-item h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .experience-item p,
        .project-item p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .ats-breakdown {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ats-criteria-item {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-primary));
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        /* ATS Tooltip Styles */
        .ats-tooltip-container {
            position: relative;
            display: inline-block;
        }

        .info-icon {
            font-size: 14px;
            cursor: help;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .info-icon:hover {
            opacity: 1;
        }

        .tooltip-content {
            position: absolute;
            top: 50%;
            right: calc(100% + 12px);
            transform: translateY(-50%);
            width: 280px;
            padding: 14px;
            background: linear-gradient(135deg, var(--bg-card), rgba(139, 92, 246, 0.05));
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 1000;
            font-size: 12px;
            line-height: 1.6;
        }

        .tooltip-content::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            border: 8px solid transparent;
            border-left-color: var(--accent-purple);
        }

        .ats-tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0);
        }

        .tooltip-content strong {
            display: block;
            margin-bottom: 8px;
            color: var(--accent-purple);
        }

        .tooltip-content p {
            margin: 6px 0;
            color: var(--text-secondary);
        }

        .tooltip-content ul {
            margin: 8px 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }

        .tooltip-content ul li {
            margin: 4px 0;
        }

        @media (max-width: 768px) {
            [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Expose functions to window since we're in a module now
        window.reUploadResume = reUploadResume;
        window.analyzeResume = analyzeResume;

        // Role-specific ATS Keywords Database
        const ATS_KEYWORDS = {
            'sde': {
                technical: ['javascript', 'python', 'java', 'c++', 'react', 'node.js', 'sql', 'git', 'api', 'rest', 'mongodb', 'aws', 'docker', 'kubernetes', 'microservices', 'agile', 'scrum', 'data structures', 'algorithms', 'oop', 'system design'],
                soft: ['problem solving', 'teamwork', 'communication', 'collaboration', 'leadership', 'analytical'],
                experience: ['software development', 'full stack', 'backend', 'frontend', 'coding', 'programming', 'debugging', 'testing']
            },
            'frontend': {
                technical: ['html', 'css', 'javascript', 'react', 'vue', 'angular', 'typescript', 'sass', 'webpack', 'responsive design', 'ui/ux', 'figma', 'tailwind', 'bootstrap', 'redux', 'next.js', 'accessibility', 'web performance'],
                soft: ['creativity', 'attention to detail', 'communication', 'collaboration', 'user-focused'],
                experience: ['frontend development', 'web development', 'ui development', 'responsive design', 'cross-browser']
            },
            'backend': {
                technical: ['node.js', 'python', 'java', 'spring boot', 'express', 'django', 'flask', 'sql', 'postgresql', 'mongodb', 'redis', 'api', 'rest', 'graphql', 'microservices', 'docker', 'kubernetes', 'aws', 'azure', 'ci/cd'],
                soft: ['problem solving', 'analytical thinking', 'teamwork', 'communication', 'scalability mindset'],
                experience: ['backend development', 'server-side', 'database design', 'api development', 'system architecture']
            },
            'fullstack': {
                technical: ['javascript', 'react', 'node.js', 'python', 'sql', 'mongodb', 'html', 'css', 'git', 'api', 'rest', 'docker', 'aws', 'typescript', 'express', 'redux', 'postgresql'],
                soft: ['versatility', 'problem solving', 'communication', 'teamwork', 'adaptability'],
                experience: ['full stack development', 'end-to-end development', 'frontend', 'backend', 'web development']
            },
            'data-analyst': {
                technical: ['python', 'sql', 'excel', 'tableau', 'power bi', 'pandas', 'numpy', 'statistics', 'data visualization', 'r', 'machine learning', 'data mining', 'etl', 'big data'],
                soft: ['analytical thinking', 'attention to detail', 'communication', 'business acumen', 'problem solving'],
                experience: ['data analysis', 'business intelligence', 'reporting', 'data visualization', 'insights']
            },
            'data-scientist': {
                technical: ['python', 'machine learning', 'deep learning', 'tensorflow', 'pytorch', 'scikit-learn', 'sql', 'statistics', 'nlp', 'computer vision', 'pandas', 'numpy', 'jupyter', 'aws', 'spark'],
                soft: ['analytical thinking', 'problem solving', 'communication', 'research', 'innovation'],
                experience: ['data science', 'machine learning', 'predictive modeling', 'ai', 'research']
            },
            'ml-engineer': {
                technical: ['python', 'tensorflow', 'pytorch', 'machine learning', 'deep learning', 'mlops', 'docker', 'kubernetes', 'aws', 'model deployment', 'scikit-learn', 'neural networks', 'computer vision', 'nlp'],
                soft: ['problem solving', 'innovation', 'collaboration', 'analytical thinking', 'research'],
                experience: ['ml engineering', 'model development', 'ai', 'production ml', 'mlops']
            },
            'devops': {
                technical: ['docker', 'kubernetes', 'jenkins', 'ci/cd', 'aws', 'azure', 'terraform', 'ansible', 'linux', 'bash', 'python', 'git', 'monitoring', 'prometheus', 'grafana', 'nginx'],
                soft: ['automation mindset', 'problem solving', 'collaboration', 'reliability focus', 'communication'],
                experience: ['devops', 'infrastructure', 'automation', 'deployment', 'cloud engineering']
            },
            'product': {
                technical: ['product management', 'agile', 'scrum', 'jira', 'analytics', 'roadmap', 'user stories', 'wireframing', 'sql', 'a/b testing'],
                soft: ['leadership', 'communication', 'strategic thinking', 'stakeholder management', 'decision making'],
                experience: ['product management', 'product development', 'product strategy', 'user research', 'feature prioritization']
            },
            'designer': {
                technical: ['figma', 'sketch', 'adobe xd', 'photoshop', 'illustrator', 'ui/ux', 'wireframing', 'prototyping', 'user research', 'design systems', 'responsive design', 'accessibility'],
                soft: ['creativity', 'empathy', 'communication', 'collaboration', 'attention to detail'],
                experience: ['ui/ux design', 'product design', 'user experience', 'visual design', 'interaction design']
            }
        };

        // Calculate ATS Score
        function calculateATSScore(resumeText, targetRole) {
            const keywords = ATS_KEYWORDS[targetRole] || ATS_KEYWORDS['sde'];
            const resumeLower = resumeText.toLowerCase();

            // 1. Keyword Match Score (50% weight)
            const allKeywords = [...keywords.technical, ...keywords.soft, ...keywords.experience];
            const matchedKeywords = allKeywords.filter(kw => resumeLower.includes(kw.toLowerCase()));
            const keywordScore = Math.round((matchedKeywords.length / allKeywords.length) * 100);

            // 2. Experience Relevance Score (30% weight)
            const experienceKeywords = keywords.experience;
            const matchedExperience = experienceKeywords.filter(kw => resumeLower.includes(kw.toLowerCase()));
            const experienceScore = Math.round((matchedExperience.length / experienceKeywords.length) * 100);

            // 3. Format Compatibility Score (20% weight)
            let formatScore = 100;
            // Check for common ATS-friendly indicators
            if (!resumeLower.includes('experience') && !resumeLower.includes('work history')) formatScore -= 20;
            if (!resumeLower.includes('education')) formatScore -= 15;
            if (!resumeLower.includes('skills')) formatScore -= 15;
            if (resumeText.length < 200) formatScore -= 30; // Too short
            if (resumeText.length > 5000) formatScore -= 20; // Too long
            formatScore = Math.max(0, formatScore);

            // Calculate overall ATS score (weighted average)
            const overallScore = Math.round(
                (keywordScore * 0.5) +
                (experienceScore * 0.3) +
                (formatScore * 0.2)
            );

            // Generate suggestions
            const suggestions = [];
            if (keywordScore < 60) {
                const missingTech = keywords.technical.filter(kw => !resumeLower.includes(kw.toLowerCase())).slice(0, 5);
                suggestions.push(`Add key technical skills: ${missingTech.join(', ')}`);
            }
            if (experienceScore < 50) {
                suggestions.push(`Include more relevant experience keywords like "${keywords.experience[0]}" or "${keywords.experience[1]}"`);
            }
            if (!resumeLower.includes('quantif') && !resumeLower.includes('achiev')) {
                suggestions.push('Add quantifiable achievements (e.g., "Improved performance by 30%")');
            }
            if (formatScore < 80) {
                suggestions.push('Ensure your resume has clear sections: Experience, Education, Skills');
            }
            if (resumeText.length < 300) {
                suggestions.push('Expand your resume with more details about your experience and projects');
            }
            if (overallScore >= 80) {
                suggestions.push('Great job! Your resume is well-optimized for ATS systems');
            }

            return {
                overall: overallScore,
                keyword: keywordScore,
                experience: experienceScore,
                format: formatScore,
                suggestions: suggestions,
                matchedKeywords: matchedKeywords
            };
        }

        // Load user data
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
            const userType = localStorage.getItem('userType');

            // Show ATS tooltip only for freshers/students, not for career gap users
            const tooltipContainer = document.getElementById('ats-tooltip-container');
            if (tooltipContainer) {
                if (userType === 'student' || userData.experienceLevel === 'student' || userData.experienceLevel === 'fresher') {
                    tooltipContainer.style.display = 'inline-block';
                } else {
                    tooltipContainer.style.display = 'none';
                }
            }

            // Check if already analyzed
            const resumeData = localStorage.getItem('nextStep_resume');
            if (resumeData) {
                showResults(JSON.parse(resumeData));
            }
        });

        // File upload handling
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) analyzeResume(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) analyzeResume(file);
        });

        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(" ") + "\n";
                }
                return text;
            } catch (error) {
                console.error('[PDF] Extraction failed:', error);
                return null;
            }
        }

        async function analyzeResume(file) {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('analyzing-section').classList.remove('hidden');

            const statusText = document.querySelector('#analyzing-section .text-muted');
            const progressBar = document.getElementById('analysis-progress');

            // Get user's target role
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
            const targetRole = userProfile.targetRole || userData.targetRole || 'sde';

            // Progress callback to update UI
            const onProgress = (update) => {
                const messages = {
                    'starting': 'Connecting to AI service...',
                    'uploading': file.type === 'application/pdf' ? 'Uploading PDF to AI...' : 'Sending resume data...',
                    'processing': 'AI is analyzing your resume...',
                    'complete': 'Analysis complete!'
                };

                if (update.message) {
                    statusText.textContent = update.message;
                } else if (messages[update.stage]) {
                    statusText.textContent = messages[update.stage];
                }

                // Update progress bar based on stage
                const progressMap = {
                    'starting': 10,
                    'uploading': 30,
                    'processing': 60,
                    'complete': 100
                };
                if (progressMap[update.stage]) {
                    progressBar.style.width = progressMap[update.stage] + '%';
                }
            };

            try {
                // Use Gemini AI
                if (file && window.GeminiService && window.GeminiService.isAvailable()) {
                    const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

                    statusText.textContent = 'Preparing to analyze your resume...';
                    progressBar.style.width = '5%';

                    let aiResult;
                    if (isPDF) {
                        statusText.textContent = 'Extracting text from PDF...';
                        progressBar.style.width = '15%';
                        const extractedText = await extractTextFromPDF(file);

                        if (extractedText && extractedText.trim().length > 100) {
                            console.log('[Resume] Using extracted text for analysis');
                            statusText.textContent = 'AI analyzing resume text...';
                            progressBar.style.width = '25%';
                            aiResult = await window.GeminiService.analyzeResume(extractedText, targetRole, onProgress);
                        } else {
                            console.log('[Resume] Falling back to multimodal PDF analysis');
                            statusText.textContent = 'AI analyzing PDF layout...';
                            progressBar.style.width = '25%';
                            aiResult = await window.GeminiService.analyzePDF(file, targetRole, onProgress);
                        }
                    } else {
                        const text = await file.text();
                        progressBar.style.width = '20%';
                        aiResult = await window.GeminiService.analyzeResume(text, targetRole, onProgress);
                    }

                    if (!aiResult) {
                        throw new Error('AI failed to produce a valid analysis. Please try again or check your API key.');
                    }

                    progressBar.style.width = '95%';
                    statusText.textContent = 'Finalizing analysis...';

                    const result = {
                        skills: aiResult.skills,
                        experience: aiResult.experience,
                        projects: aiResult.projects,
                        score: aiResult.score || 0,
                        coverage: aiResult.coverage || 0,
                        readiness: aiResult.readiness || 0,
                        atsScore: aiResult.atsScore || null,
                        _aiGenerated: true
                    };

                    progressBar.style.width = '100%';
                    setTimeout(() => showResults(result), 500);
                    return;
                } else {
                    throw new Error('AI Service not available. Check your configuration.');
                }

            } catch (error) {
                console.error('[Resume] Analysis error:', error);

                // Determine if we should show a retry option or fallback
                const isTimeout = error.message.includes('timeout') || error.message.includes('taking longer');
                const isRateLimit = error.message.includes('429') || error.message.includes('Rate Limit') || error.message.includes('busy');
                const isNetworkError = error.message.includes('network') || error.message.includes('Connection');

                // Build user-friendly error message
                let errorTitle = 'Analysis Error';
                let errorMessage = error.message;
                let showRetry = true;
                let showFallback = false;

                if (isTimeout) {
                    errorTitle = 'Analysis Taking Too Long';
                    errorMessage = error.message + '\n\nTips:\n‚Ä¢ Try a smaller file\n‚Ä¢ Use a text-based resume instead of PDF\n‚Ä¢ Retry in a moment';
                    showFallback = true;
                } else if (isRateLimit) {
                    errorTitle = 'Service Busy';
                    errorMessage = error.message;
                    showFallback = true;
                } else if (isNetworkError) {
                    errorTitle = 'Connection Issue';
                    errorMessage = error.message + '\n\nPlease check your internet connection and try again.';
                }

                // Show error dialog with options
                const userChoice = confirm(
                    `${errorTitle}\n\n${errorMessage}\n\n` +
                    (showFallback ? 'Would you like to use local analysis instead? (Click OK for local analysis, Cancel to retry)' : 'Click OK to retry, Cancel to go back.')
                );

                if (userChoice && showFallback) {
                    // Use local fallback analysis
                    console.warn('[Resume] Using local analysis fallback');
                    statusText.textContent = 'Using local analysis engine...';
                    progressBar.style.width = '40%';

                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const extractedText = await extractTextFromPDF(file);
                    const localResult = calculateATSScore(extractedText || "", targetRole);

                    progressBar.style.width = '80%';

                    const result = {
                        skills: {
                            present: localResult.matchedKeywords.slice(0, 10),
                            partial: [],
                            missing: []
                        },
                        experience: [],
                        projects: [],
                        score: localResult.overall,
                        coverage: localResult.keyword,
                        readiness: localResult.overall,
                        atsScore: localResult,
                        _aiGenerated: false,
                        _fallback: true
                    };

                    progressBar.style.width = '100%';
                    setTimeout(() => showResults(result), 500);
                } else if (userChoice && !showFallback) {
                    // Retry
                    analyzeResume(file);
                } else {
                    // Cancel - reset UI
                    document.getElementById('upload-section').classList.remove('hidden');
                    document.getElementById('analyzing-section').classList.add('hidden');
                    progressBar.style.width = '0%';
                }
            }
        }


        function showResults(data) {
            // Normalize skills data to expected format {present:[], partial:[], missing:[]}
            if (data.skills && Array.isArray(data.skills)) {
                // Skills is a flat array, convert to expected format
                data.skills = { present: data.skills, partial: [], missing: data.missing || [] };
            } else if (!data.skills) {
                data.skills = { present: [], partial: [], missing: [] };
            } else {
                // Ensure all sub-arrays exist
                data.skills.present = data.skills.present || [];
                data.skills.partial = data.skills.partial || [];
                data.skills.missing = data.skills.missing || [];
            }

            // Save to localStorage
            localStorage.setItem('nextStep_resume', JSON.stringify(data));

            // Save to Firestore if user is logged in
            saveResumeToDatabase(data);

            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('analyzing-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');

            // Get user's target role
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
            const targetRole = userProfile.targetRole || userData.targetRole || 'sde';

            // Calculate ATS Score
            const presentSkills = data?.skills?.present || [];
            const partialSkills = data?.skills?.partial || [];
            const projects = data?.projects || [];

            const resumeText = `
                Skills: ${[...presentSkills, ...partialSkills].join(', ')}
                Experience: Software Development, Programming, Coding
                Education: Computer Science
                Projects: ${projects.map(p => (p?.name || '') + ' ' + (p?.tech || '')).join(', ')}
            `;
            const atsResult = calculateATSScore(resumeText, targetRole);

            // Update stats
            document.getElementById('resume-score').textContent = (data?.score || 0) + '/100';
            document.getElementById('skill-coverage').textContent = (data?.coverage || 0) + '%';
            document.getElementById('missing-count').textContent = data?.skills?.missing?.length || 0;
            document.getElementById('readiness').textContent = (data?.readiness || 0) + '%';

            // Update ATS Score with animation
            setTimeout(() => {
                document.getElementById('ats-score').textContent = atsResult.overall + '%';
                document.getElementById('ats-progress').style.width = atsResult.overall + '%';
                document.getElementById('keyword-score').textContent = atsResult.keyword + '%';
                document.getElementById('keyword-progress').style.width = atsResult.keyword + '%';
                document.getElementById('experience-score').textContent = atsResult.experience + '%';
                document.getElementById('experience-progress').style.width = atsResult.experience + '%';
                document.getElementById('format-score').textContent = atsResult.format + '%';
                document.getElementById('format-progress').style.width = atsResult.format + '%';

                // Update ATS badge
                const badge = document.getElementById('ats-badge');
                if (atsResult.overall >= 80) {
                    badge.textContent = 'Excellent';
                    badge.style.background = 'var(--accent-green)';
                } else if (atsResult.overall >= 60) {
                    badge.textContent = 'Good';
                    badge.style.background = 'var(--accent-primary)';
                } else if (atsResult.overall >= 40) {
                    badge.textContent = 'Fair';
                    badge.style.background = 'var(--accent-gold)';
                } else {
                    badge.textContent = 'Needs Improvement';
                    badge.style.background = 'var(--accent-red)';
                }

            }, 300);

            // Skills found
            const foundSkills = [...data.skills.present, ...data.skills.partial];
            document.getElementById('found-count').textContent = foundSkills.length + ' skills';
            // Render Found Skills
            const foundEl = document.getElementById('skills-found');
            foundEl.innerHTML = '';
            (data.skills?.present || []).forEach((skill, index) => {
                const tag = document.createElement('div');
                tag.className = 'skill-tag present animate-in';
                tag.style.animationDelay = `${index * 0.05}s`;
                tag.innerHTML = `<span>‚úÖ</span> ${skill}`;
                foundEl.appendChild(tag);
            });

            // Render Missing Skills
            const missingEl = document.getElementById('skills-missing');
            missingEl.innerHTML = '';
            const missingSkills = data.skills?.missing || [];
            missingSkills.forEach((skill, index) => {
                const tag = document.createElement('div');
                tag.className = 'skill-tag missing animate-in';
                tag.style.animationDelay = `${((data.skills?.present?.length || 0) + index) * 0.05}s`;
                tag.innerHTML = `<span>‚ùå</span> ${skill}`;
                missingEl.appendChild(tag);
            });

            // Suggestions
            const suggestionsEl = document.getElementById('ats-suggestions');
            suggestionsEl.innerHTML = '';
            const suggestions = data?.atsScore?.suggestions || data?.suggestions || [];
            suggestions.forEach((text, index) => {
                const li = document.createElement('li');
                li.className = 'animate-in';
                li.style.animationDelay = `${((data.skills?.present?.length || 0) + missingSkills.length + index) * 0.1}s`;
                li.textContent = text;
                suggestionsEl.appendChild(li);
            });
            // Experience
            document.getElementById('experience-list').innerHTML = (data.experience || []).map((e, index) => `
                <div class="experience-item animate-in" style="animation-delay: ${index * 0.15}s">
                    <h4>${e.role || 'Role'}</h4>
                    <p>${e.company || 'Company'} ‚Ä¢ ${e.duration || ''}</p>
                </div>
            `).join('');

            // Projects
            document.getElementById('projects-list').innerHTML = (data.projects || []).map((p, index) => `
                <div class="project-item animate-in" style="animation-delay: ${index * 0.15}s">
                    <h4>${p.name || 'Project Name'}</h4>
                    <p>${p.tech || ''}</p>
                </div>
            `).join('');
        }

        // Re-upload resume function
        function reUploadResume() {
            // Clear existing resume data
            localStorage.removeItem('nextStep_resume');

            // Hide results and show upload section
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');

            // Reset file input
            document.getElementById('file-input').value = '';

            // Show notification
            alert('üîÑ Ready to upload a new resume!');
        }
        // Database Integration
        async function saveResumeToDatabase(data) {
            try {
                // Wait for auth to initialize if it hasn't yet
                const user = await new Promise((resolve) => {
                    if (auth.currentUser) return resolve(auth.currentUser);
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe();
                        resolve(user);
                    });
                    // Timeout after 3 seconds if auth still hasn't settled
                    setTimeout(() => resolve(auth.currentUser), 3000);
                });

                if (!user) {
                    console.log('[Database] ‚ö†Ô∏è User not logged in to Firebase Auth, skipping cloud save');
                    return;
                }

                console.log('[Database] Saving resume analysis to Firestore (UID: ' + user.uid + ')...');
                await setDoc(doc(db, "users", user.uid, "analysis", "resume"), {
                    ...data,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                console.log('[Database] ‚úÖ Resume analysis saved successfully');
            } catch (error) {
                console.error('[Database] ‚ùå Error saving resume:', error);
            }
        }

        // Check for pending resume file from onboarding (after analyzeResume is defined)
        window.addEventListener('load', async () => {
            // Don't process if already analyzed
            const resumeData = localStorage.getItem('nextStep_resume');
            if (resumeData) {
                return;
            }

            // Check for pending resume file from onboarding
            const pendingFileData = localStorage.getItem('pendingResumeFile');
            if (pendingFileData) {
                try {
                    const fileData = JSON.parse(pendingFileData);
                    console.log('[Resume] Found pending resume file from onboarding:', fileData.name);

                    // Convert base64 back to File object
                    const response = await fetch(fileData.data);
                    const blob = await response.blob();
                    const file = new File([blob], fileData.name, {
                        type: fileData.type,
                        lastModified: fileData.lastModified
                    });

                    // Clear the pending file from storage
                    localStorage.removeItem('pendingResumeFile');

                    // Automatically analyze the file
                    console.log('[Resume] Auto-analyzing resume from onboarding...');
                    setTimeout(() => analyzeResume(file), 100); // Small delay to ensure DOM is ready
                } catch (error) {
                    console.error('[Resume] Error processing pending file:', error);
                    // Clear the corrupted data
                    localStorage.removeItem('pendingResumeFile');
                }
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="js/sidebar.js" type="module"></script>
    <script src="js/click-spark.js"></script>
</body>

</html>