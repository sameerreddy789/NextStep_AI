<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Gap Analysis | NextStep AI</title>
    <meta name="description" content="See what skills you need vs what you have">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animated-background.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="js/env-config.js"></script>
    <script src="js/route-guard.js"></script>
    <script src="js/serp-service.js"></script>
    <script src="js/gemini-service.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (populated by sidebar.js) -->
        <aside class="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">üìä Skill Gap Analysis</h1>
                <p class="page-subtitle">Compare your skills against market requirements for your target role</p>
            </div>

            <!-- Target Role Card -->
            <div class="card mb-lg"
                style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">Target Role</div>
                        <div style="font-size: 24px; font-weight: 700;" id="target-role-display">Analyzing...</div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" style="text-align: center; padding: 40px;">
                <div class="loader-spinner"
                    style="width: 40px; height: 40px; border: 3px solid rgba(139, 92, 246, 0.1); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;">
                </div>
                <p style="color: var(--accent-primary); font-weight: 600;">Analyzing market trends for your role...</p>
                <p class="text-muted" style="font-size: 14px;">Comparing your resume with industry standard requirements
                </p>
            </div>

            <!-- Skill Categories (Hidden initially) -->
            <div id="skills-results" class="skills-grid hidden" style="grid-template-columns: 1fr;">
                <!-- Must-Have Skills -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üî¥ Must-Have Skills</h2>
                        <span class="badge badge-red">High Priority</span>
                    </div>
                    <div id="must-have-skills" class="skill-gap-list"></div>
                </div>

                <!-- Good-to-Have Skills -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üü° Good-to-Have Skills</h2>
                        <span class="badge badge-gold">Medium Priority</span>
                    </div>
                    <div id="good-to-have-skills" class="skill-gap-list"></div>
                </div>

                <!-- Future-Proof Skills -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üü¢ Future-Proof Skills</h2>
                        <span class="badge badge-green">Growing Demand</span>
                    </div>
                    <div id="future-proof-skills" class="skill-gap-list"></div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .skill-gap-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .skill-gap-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .skill-gap-item:hover {
            background: rgba(255, 255, 255, 0.04);
            transform: translateX(4px);
        }

        .skill-gap-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            font-weight: 800;
        }

        .skill-gap-icon.present {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .skill-gap-icon.partial {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .skill-gap-icon.missing {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .skill-gap-content {
            flex: 1;
        }

        .skill-gap-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .skill-gap-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .skill-gap-status {
            text-align: right;
            flex-shrink: 0;
        }

        .skill-gap-priority {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}') || {};
            const resumeDataRaw = localStorage.getItem('nextStep_resume');
            const resumeData = (resumeDataRaw && resumeDataRaw !== 'undefined' && resumeDataRaw !== 'null') ? JSON.parse(resumeDataRaw) : { skills: [] };

            const userSkills = Array.isArray(resumeData?.skills) ? resumeData.skills : [];
            const role = userData.targetRole || 'Software Developer';
            document.getElementById('target-role-display').textContent = role.charAt(0).toUpperCase() + role.slice(1);

            try {
                // 1. Fetch real market context via SERP
                const marketData = await window.SerpService.fetchRoleContext(role);

                // 2. Analyze gaps via Gemini
                const analysis = await window.GeminiService.analyzeMarketSkills(
                    role,
                    marketData,
                    userSkills
                );

                // 3. Render results
                renderSkillList('must-have-skills', analysis.mustHave);
                renderSkillList('good-to-have-skills', analysis.goodToHave);
                renderSkillList('future-proof-skills', analysis.futureProof);

                // 4. Show results
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('skills-results').classList.remove('hidden');

            } catch (error) {
                console.error('Skill Gap Analysis Failed:', error);
                document.getElementById('loading-overlay').innerHTML = `
                    <div style="color: #ef4444; padding: 20px;">
                        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <h3 style="margin-bottom: 8px;">Analysis Failed</h3>
                        <p style="font-size:14px; opacity:0.8;">${error.message}</p>
                        <button onclick="location.reload()" class="btn btn-secondary btn-sm" style="margin-top:20px;">Try Again</button>
                    </div>
                `;
            }
        });

        function renderSkillList(containerId, skills) {
            const container = document.getElementById(containerId);
            if (!skills || skills.length === 0) {
                container.innerHTML = '<p class="text-muted" style="padding: 20px; text-align: center;">No specific skills identified in this category.</p>';
                return;
            }

            container.innerHTML = skills.map(skill => {
                const statusIcon = skill.status === 'present' ? '‚úì' : skill.status === 'partial' ? '‚óê' : '‚úó';
                const statusLabel = skill.status === 'present' ? 'Demonstrated' : skill.status === 'partial' ? 'Partial' : 'Missing';
                const badgeClass = skill.status === 'present' ? 'badge-primary' : skill.status === 'partial' ? 'badge-gold' : 'badge-red';

                return `
                    <div class="skill-gap-item">
                        <div class="skill-gap-icon ${skill.status}">${statusIcon}</div>
                        <div class="skill-gap-content">
                            <div class="skill-gap-name">${skill.name}</div>
                            <div class="skill-gap-desc">${skill.desc}</div>
                        </div>
                        <div class="skill-gap-status">
                            <span class="badge ${badgeClass}">${statusLabel}</span>
                            <div class="skill-gap-priority">${skill.priority}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
    <script src="js/sidebar.js"></script>
    <script src="js/click-spark.js"></script>
</body>

</html>