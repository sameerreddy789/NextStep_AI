<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Gap Analysis | NextStep AI</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="description" content="See what skills you need vs what you have">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/stats-bar.css">
    <link rel="stylesheet" href="css/animated-background.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/env-config.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/route-guard.js"></script>
    <script src="js/serp-service.js"></script>
    <script src="js/gemini-service.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (populated by sidebar.js) -->
        <aside class="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">üìä Skill Gap Analysis</h1>
                    <p class="page-subtitle">Compare your skills against market requirements for your target role</p>
                </div>
                <div class="role-input-container">
                    <input type="text" id="role-input" class="role-input"
                        placeholder="Target role (e.g. Full Stack Dev)...">
                    <button class="explorer-toggle-btn" onclick="toggleDrawer()">
                        <span>üß≠</span> Explorer
                    </button>
                    <button id="update-role-btn" class="refresh-btn">Update</button>
                </div>
            </div>

            <!-- Loading Overlay (Strictly Hides Content) -->
            <div id="loading-overlay" class="hidden">
                <div class="shimmer-container" style="max-width: 800px; margin: 40px auto; display: grid; gap: 20px;">
                    <div class="shimmer-box" style="height: 300px; border-radius: 16px;"></div>
                    <div class="shimmer-card" style="height: 120px; border-radius: 12px;"></div>
                    <div class="shimmer-card" style="height: 120px; border-radius: 12px;"></div>
                </div>
                <div style="text-align: center; margin-top: 24px;">
                    <p class="loading-text">
                        Analyzing market data for <span id="loading-role-name" style="color: var(--accent-primary)">your
                            role</span>...
                    </p>
                </div>
            </div>

            <!-- Results Container -->
            <div id="skills-results">

                <!-- Hero Section: Chart & Score -->
                <div class="analysis-hero">
                    <div class="chart-container">
                        <canvas id="skillRadarChart"></canvas>
                    </div>
                    <div class="score-card">
                        <div class="score-ring">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" id="score-circle" stroke-dasharray="0, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="score-text">
                                <span id="match-percentage">0%</span>
                                <small>Match</small>
                            </div>
                        </div>
                        <div class="score-details">
                            <h3>Role Fit</h3>
                            <p id="match-label" class="text-muted">Analyzing...</p>
                        </div>
                    </div>
                </div>

                <!-- Skill Categories Grid -->
                <div class="skills-grid-new">
                    <!-- Must-Have Skills -->
                    <div class="skill-column">
                        <div class="column-header" style="border-bottom: 2px solid #ef4444;">
                            <h3>üî• Must-Have</h3>
                            <span class="count-badge" id="count-must-have">0</span>
                        </div>
                        <div id="must-have-skills" class="skill-cards-container"></div>
                    </div>

                    <!-- Good-to-Have Skills -->
                    <div class="skill-column">
                        <div class="column-header" style="border-bottom: 2px solid #f59e0b;">
                            <h3>üåü Good-to-Have</h3>
                            <span class="count-badge" id="count-good-to-have">0</span>
                        </div>
                        <div id="good-to-have-skills" class="skill-cards-container"></div>
                    </div>

                    <!-- Future-Proof Skills -->
                    <div class="skill-column">
                        <div class="column-header" style="border-bottom: 2px solid #10b981;">
                            <h3>üöÄ Future-Proof</h3>
                            <span class="count-badge" id="count-future-proof">0</span>
                        </div>
                        <div id="future-proof-skills" class="skill-cards-container"></div>
                    </div>
                </div>
            </div>

            <!-- Role & Skill Explorer Drawer -->
            <div id="explorer-overlay" class="drawer-overlay hidden" onclick="toggleDrawer()"></div>
            <div id="explorer-drawer" class="explorer-drawer">
                <div class="drawer-header">
                    <h2>Career Explorer</h2>
                    <button class="close-drawer" onclick="toggleDrawer()">‚úï</button>
                </div>
                <div class="drawer-content">
                    <div class="drawer-section">
                        <h3>üéØ Popular Roles</h3>
                        <div class="role-pills" id="role-explorer-list"></div>
                    </div>
                    <div class="drawer-section">
                        <h3>üõ†Ô∏è Skill Builder</h3>
                        <p class="section-hint">Manually toggle skills to test your readiness</p>
                        <div class="skill-toggles" id="skill-explorer-list"></div>
                    </div>
                </div>
                <div class="drawer-footer">
                    <button class="btn btn-primary" style="width: 100%" onclick="applyExplorerChanges()">Apply
                        Analysis</button>
                </div>
            </div>

        </main>
    </div>

    <style>
        /* --- New Layout Styles --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 24px;
        }

        .role-input-container {
            display: flex;
            gap: 10px;
            background: rgba(15, 20, 25, 0.4);
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .role-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 15px;
            width: 200px;
            outline: none;
        }

        /* Hero Section */
        .analysis-hero {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background: rgba(25, 30, 40, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .score-card {
            background: linear-gradient(135deg, rgba(30, 35, 45, 0.6), rgba(20, 25, 35, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Circular Progress */
        .score-ring {
            width: 140px;
            height: 140px;
            position: relative;
            margin-bottom: 16px;
        }

        .circular-chart {
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 2.5;
        }

        .circle {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: 2.5;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease-out;
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-text span {
            display: block;
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
        }

        .score-text small {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Skills Grid */
        .skills-grid-new {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .column-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .count-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .skill-cards-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* New Skill Card */
        .skill-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .skill-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .skill-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .skill-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .skill-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.05);
        }

        .skill-name {
            font-weight: 600;
            font-size: 14px;
        }

        .skill-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .skill-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-pill {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-pill.missing {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-pill.partial {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-pill.present {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .add-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        @media (max-width: 768px) {
            .analysis-hero {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .role-input-container {
                width: 100%;
            }
        }

        /* Explorer Drawer Styles */
        .explorer-toggle-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .explorer-toggle-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }

        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
        }

        .explorer-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #12161f;
            border-left: 1px solid var(--border-color);
            z-index: 2001;
            display: flex;
            flex-direction: column;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 50px rgba(0, 0, 0, 0.5);
        }

        .explorer-drawer.active {
            right: 0;
        }

        .drawer-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .close-drawer {
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-drawer:hover {
            color: white;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .drawer-section {
            margin-bottom: 32px;
        }

        .drawer-section h3 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .role-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .role-pill {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .role-pill:hover,
        .role-pill.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
            color: white;
        }

        .skill-toggles {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .skill-toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-toggle-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .skill-toggle-item.active {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .skill-toggle-item .info {
            display: flex;
            flex-direction: column;
        }

        .skill-toggle-item .name {
            font-size: 14px;
            font-weight: 600;
        }

        .skill-toggle-item .check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: transparent;
            transition: all 0.2s;
        }

        .skill-toggle-item.active .check {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .section-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .drawer-footer {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            background: rgba(15, 20, 25, 0.5);
        }

        @media (max-width: 450px) {
            .explorer-drawer {
                width: 100%;
                right: -100%;
            }
        }

        /* Shimmer Animation */
        .shimmer-box,
        .shimmer-card {
            background: #1e2430;
            background-image: linear-gradient(to right, #1e2430 0%, #2a3140 20%, #1e2430 40%, #1e2430 100%);
            background-repeat: no-repeat;
            background-size: 800px 100%;
            animation-duration: 1.5s;
            animation-fill-mode: forwards;
            animation-iteration-count: infinite;
            animation-name: shimmer;
            animation-timing-function: linear;
        }

        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }

            100% {
                background-position: 468px 0;
            }
        }
    </style>

    <script>
        // Global Explorer Data
        const EXPLORER_ROLES = [
            'Software Developer', 'Frontend Developer', 'Backend Developer',
            'Full Stack Developer', 'Data Analyst', 'Data Scientist',
            'ML Engineer', 'DevOps Engineer', 'Product Manager', 'UI/UX Designer'
        ];

        const COMMON_SKILLS = [
            'JavaScript', 'Python', 'SQL', 'React', 'Node.js',
            'AWS', 'Git', 'Docker', 'API Design', 'System Design'
        ];

        let selectedExplorerRole = '';
        let selectedExplorerSkills = new Set();
        let radarChart = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}') || {};
            const initialRole = userData.targetRole || 'Software Developer';
            const roleInput = document.getElementById('role-input');
            const updateBtn = document.getElementById('update-role-btn');

            if (roleInput) {
                roleInput.value = initialRole;
                selectedExplorerRole = initialRole;

                // Automatic Update (Debounced)
                let debounceTimer;
                const debouncedUpdate = (role) => {
                    clearTimeout(debounceTimer);
                    if (role) {
                        debounceTimer = setTimeout(() => performAnalysis(role), 1200);
                    }
                };

                roleInput.addEventListener('input', (e) => debouncedUpdate(e.target.value.trim()));
                roleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        clearTimeout(debounceTimer);
                        const newRole = Math.round.value.trim();
                        if (newRole) performAnalysis(newRole);
                    }
                });
            }

            if (updateBtn) {
                updateBtn.addEventListener('click', () => {
                    const role = roleInput ? roleInput.value.trim() : initialRole;
                    if (role) {
                        // FORCE REFRESH on manual click
                        performAnalysis(role, true);
                        if (window.showToast) window.showToast('Refreshing analysis...', 'info');
                    }
                });
            }

            // Initialize Explorer Content
            initExplorer();

            // Initial Analysis
            performAnalysis(initialRole);
        });

        async function performAnalysis(role, forceRefresh = false) {
            const loading = document.getElementById('loading-overlay');
            const results = document.getElementById('skills-results');

            // Cache Key
            const cacheKey = `nextStep_skillGap_${role.toLowerCase().replace(/\s+/g, '_')}`;

            // Check Cache
            if (!forceRefresh) {
                const cachedRaw = localStorage.getItem(cacheKey);
                if (cachedRaw) {
                    try {
                        const cached = JSON.parse(cachedRaw);
                        // Optional: Check expiry (e.g., 24 hours). For now, we trust it until manual refresh.
                        if (cached && cached.timestamp && (Date.now() - cached.timestamp < 24 * 60 * 60 * 1000)) {
                            console.log('[SkillGap] ‚ö° Loading from cache:', role);
                            renderAnalysisResult(cached.data, role);
                            return;
                        }
                    } catch (e) {
                        console.warn('[SkillGap] Cache parse failed, fetching fresh.');
                    }
                }
            }

            // STRICT LOADING STATE: Content is fully hidden
            if (loading) loading.classList.remove('hidden');
            if (results) results.classList.add('hidden');

            const roleNameEl = document.getElementById('loading-role-name');
            if (roleNameEl) roleNameEl.textContent = role;

            try {
                // Get User Data
                const resumeDataRaw = localStorage.getItem('nextStep_resume');
                const resumeData = (resumeDataRaw && resumeDataRaw !== 'undefined' && resumeDataRaw !== 'null') ? JSON.parse(resumeDataRaw) : { skills: {} };
                const userSkills = dataToSkillArray(resumeData?.skills);

                // Add Interview Skills
                const interviewRaw = localStorage.getItem('nextStep_interview_autosave');
                if (interviewRaw) {
                    const interviewData = JSON.parse(interviewRaw);
                    const verifiedSkills = interviewData.answers
                        ?.filter(a => a.evaluation && a.evaluation.score >= 70)
                        ?.map(a => a.category) || [];
                    verifiedSkills.forEach(s => { if (!userSkills.includes(s)) userSkills.push(s); });
                }

                // AI Analysis
                const result = await window.GeminiService.analyzeSkillGap(userSkills, role);

                // Save to Cache
                const cacheData = {
                    timestamp: Date.now(),
                    data: result
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                console.log('[SkillGap] üíæ Saved analysis to cache:', cacheKey);

                // Render UI
                renderAnalysisResult(result, role);

            } catch (error) {
                console.error('[SkillGap] Analysis failed:', error);
                if (loading) loading.classList.add('hidden');
                if (window.showToast) window.showToast('Analysis failed. Please try again.', 'error');
            }
        }

        function renderAnalysisResult(result, role) {
            const loading = document.getElementById('loading-overlay');
            const results = document.getElementById('skills-results');

            // Get User Skills again for highlighting
            const resumeData = JSON.parse(localStorage.getItem('nextStep_resume') || '{}');
            const userSkills = dataToSkillArray(resumeData?.skills);

            renderCharts(result, userSkills);
            renderSkillColumns(result.missingSkills, userSkills);

            // Reveal Content
            if (loading) loading.classList.add('hidden');
            if (results) results.classList.remove('hidden');

            // Sync Explorer
            selectedExplorerRole = role;
            updateExplorerUI();
        }

        function renderCharts(data, userSkills) {
            // Update Match Score
            const matchScore = data.matchPercentage || 0;
            const circle = document.getElementById('score-circle');
            const pctText = document.getElementById('match-percentage');
            const labelText = document.getElementById('match-label');

            if (circle && pctText && labelText) {
                // Anime the circle
                circle.style.strokeDasharray = `${matchScore}, 100`;
                circle.style.stroke = matchScore > 75 ? '#10b981' : matchScore > 50 ? '#f59e0b' : '#ef4444';
                pctText.textContent = `${matchScore}%`;

                if (matchScore > 80) labelText.innerHTML = "You are <span style='color:#10b981'>Job Ready!</span>";
                else if (matchScore > 50) labelText.innerHTML = "You are <span style='color:#f59e0b'>getting there!</span>";
                else labelText.innerHTML = "Significant <span style='color:#ef4444'>gaps detected.</span>";
            }

            // Render Radar Chart
            const ctx = document.getElementById('skillRadarChart');
            if (!ctx) return;

            if (radarChart) radarChart.destroy();

            // Mock categories for visual flair if AI doesn't provide them perfectly
            const labels = ['Frontend', 'Backend', 'Database', 'DevOps', 'Soft Skills', 'Tools'];
            // Simple logic to distribute score for demo purposes (real logic would segment skills)
            const score = matchScore;

            // Generate pseudo-random distribution based on score to make chart look dynamic but related to score
            const baseData = [
                Math.min(100, Math.max(10, score + 10)),
                Math.min(100, Math.max(10, score - 5)),
                Math.min(100, Math.max(10, score + 5)),
                Math.min(100, Math.max(10, score - 20)),
                Math.min(100, Math.max(10, score + 15)),
                Math.min(100, Math.max(10, score))
            ];

            const datasets = [{
                label: 'Your Profile',
                data: baseData,
                fill: true,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: '#6366f1',
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#6366f1'
            }, {
                label: 'Market Average',
                data: [80, 85, 75, 70, 90, 85],
                fill: true,
                backgroundColor: 'rgba(255, 255, 255, 0.05)',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                pointBackgroundColor: 'rgba(255, 255, 255, 0.2)',
                pointBorderColor: '#fff',
                borderDash: [5, 5]
            }];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#94a3b8', font: { size: 12 } },
                            ticks: { display: false, max: 100 }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } }
                    }
                }
            });
        }

        function renderSkillColumns(skills, userSkills) {
            // Clear existing
            const containers = {
                'must-have': document.getElementById('must-have-skills'),
                'good-to-have': document.getElementById('good-to-have-skills'),
                'future-proof': document.getElementById('future-proof-skills')
            };

            // Safely clear
            for (const key in containers) {
                if (containers[key]) containers[key].innerHTML = '';
            }

            // Counters
            const counts = { 'must-have': 0, 'good-to-have': 0, 'future-proof': 0 };

            if (!skills) return;

            skills.forEach((skill, index) => {
                const type = skill.priority || 'must-have';
                const container = containers[type] || containers['must-have'];
                if (!container) return;

                counts[type]++;

                // Determine status
                const isPresent = userSkills.some(s => s.toLowerCase() === skill.name.toLowerCase());
                const statusClass = isPresent ? 'present' : 'missing';
                const statusText = isPresent ? 'Have' : 'Missing';
                const icon = getIconForSkill(skill.name);

                const card = document.createElement('div');
                card.className = 'skill-card animate-in';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <div class="skill-card-header">
                        <div class="skill-info">
                            <div class="skill-icon">${icon}</div>
                            <div class="skill-name">${skill.name}</div>
                        </div>
                        <span class="status-pill ${statusClass}">${statusText}</span>
                    </div>
                    <div class="skill-desc">${skill.reason || 'Required for this role'}</div>
                    <div class="skill-footer">
                        <small class="text-muted">High Relevance</small>
                        ${!isPresent ? `<button class="add-btn" onclick="addToRoadmap('${skill.name}')">+ Add to Plan</button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });

            // Update Counts
            const countMust = document.getElementById('count-must-have');
            const countGood = document.getElementById('count-good-to-have');
            const countFuture = document.getElementById('count-future-proof');

            if (countMust) countMust.textContent = counts['must-have'];
            if (countGood) countGood.textContent = counts['good-to-have'];
            if (countFuture) countFuture.textContent = counts['future-proof'];
        }

        function addToRoadmap(skillName) {
            // Mock logic for adding to roadmap
            window.showToast(`Active: Added ${skillName} to your roadmap!`, 'success');
        }

        function getIconForSkill(name) {
            // Simple mapping for icons
            const n = name.toLowerCase();
            if (n.includes('react') || n.includes('js') || n.includes('front')) return '‚öõÔ∏è';
            if (n.includes('data') || n.includes('sql')) return 'üóÑÔ∏è';
            if (n.includes('cloud') || n.includes('aws')) return '‚òÅÔ∏è';
            if (n.includes('python') || n.includes('ai')) return 'ü§ñ';
            return '‚ö°';
        }

        // Explorer Logic (Simplified/Kept)
        function initExplorer() {
            const roleList = document.getElementById('role-explorer-list');
            const skillList = document.getElementById('skill-explorer-list');

            if (!roleList || !skillList) return;

            // Build Roles
            roleList.innerHTML = EXPLORER_ROLES.map(role => `
                <div class="role-pill ${role === selectedExplorerRole ? 'active' : ''}" 
                     onclick="setExplorerRole('${role}')">${role}</div>
            `).join('');

            // Build Skills
            const resumeData = JSON.parse(localStorage.getItem('nextStep_resume') || '{}');
            const userSkills = dataToSkillArray(resumeData?.skills);
            selectedExplorerSkills = new Set(userSkills);

            skillList.innerHTML = COMMON_SKILLS.map(skill => `
                <div class="skill-toggle-item ${selectedExplorerSkills.has(skill) ? 'active' : ''}" 
                     id="toggle-${skill}" onclick="toggleExplorerSkill('${skill}')">
                    <div class="info">
                        <span class="name">${skill}</span>
                    </div>
                    <div class="check">‚úì</div>
                </div>
            `).join('');
        }

        function dataToSkillArray(skills) {
            if (!skills) return [];
            if (Array.isArray(skills)) return skills;
            return [...(skills.present || []), ...(skills.partial || [])];
        }

        window.toggleDrawer = function () {
            const drawer = document.getElementById('explorer-drawer');
            const overlay = document.getElementById('explorer-overlay');
            if (drawer) drawer.classList.toggle('active');
            if (overlay) {
                overlay.classList.toggle('hidden');
                setTimeout(() => overlay.classList.toggle('active'), 0);
            }
        };

        window.setExplorerRole = function (role) {
            selectedExplorerRole = role;
            updateExplorerUI();
        };

        window.toggleExplorerSkill = function (skill) {
            if (selectedExplorerSkills.has(skill)) {
                selectedExplorerSkills.delete(skill);
            } else {
                selectedExplorerSkills.add(skill);
            }
            updateExplorerUI();
        };

        function updateExplorerUI() {
            // Update Roles
            document.querySelectorAll('.role-pill').forEach(pill => {
                pill.classList.toggle('active', pill.textContent === selectedExplorerRole);
            });

            // Update Skills
            COMMON_SKILLS.forEach(skill => {
                const item = document.getElementById(`toggle-${skill}`);
                if (item) item.classList.toggle('active', selectedExplorerSkills.has(skill));
            });
        }

        window.applyExplorerChanges = function () {
            // Update Main Input
            const roleInput = document.getElementById('role-input');
            if (roleInput) roleInput.value = selectedExplorerRole;

            // Update Resume Data
            const resumeData = JSON.parse(localStorage.getItem('nextStep_resume') || '{}');
            if (!resumeData.skills) resumeData.skills = { present: [], partial: [], missing: [] };
            resumeData.skills.present = Array.from(selectedExplorerSkills);
            localStorage.setItem('nextStep_resume', JSON.stringify(resumeData));

            toggleDrawer();
            performAnalysis(selectedExplorerRole);
        };
    </script>
    <script src="js/sidebar.js" type="module"></script>
    <script type="module">
        import { initStatsBar } from './js/services/stats-bar.js';
        document.addEventListener('DOMContentLoaded', () => setTimeout(initStatsBar, 100));
    </script>
    <script src="js/click-spark.js"></script>
</body>

</html>