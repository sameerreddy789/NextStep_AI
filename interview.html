<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview | NextStep AI</title>
    <meta name="description" content="Take adaptive AI-powered mock interviews">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animated-background.css">
    <link rel="stylesheet" href="css/page-transitions.css">
    <link rel="stylesheet" href="css/celebration-modal.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/editor.css">
    <script src="js/route-guard.js"></script>
    <script src="js/gemini-service.js"></script>
    <script src="js/editor.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (populated by sidebar.js) -->
        <aside class="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mode Selection (shown initially) -->
            <div id="mode-selection">
                <div class="page-header">
                    <h1 class="page-title">üé§ AI Interview</h1>
                    <p class="page-subtitle">Choose your interview mode and test your skills</p>
                </div>

                <div class="interview-modes" style="display: block; text-align: center;">
                    <div class="mode-card" style="max-width: 600px; margin: 0 auto; cursor: default;">
                        <div class="mode-icon">üß†</div>
                        <h3 class="mode-title">Adaptive AI Interview</h3>
                        <p class="mode-desc">
                            A comprehensive evaluation tailored to your role.
                            Includes <strong>Coding Challenges</strong> (with code editor) and
                            <strong>Behavioral Questions</strong> (with speech analysis).
                        </p>
                        <div class="mode-meta" style="justify-content: center; margin-bottom: 24px;">
                            <span class="badge badge-gold">Mixed Format</span>
                            <span>~30 mins</span>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="startInterview('mixed')">
                            Start AI Interview ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Interview In Progress -->
            <div id="interview-section" class="hidden">
                <div class="interview-grid">
                    <!-- Left: Question & Input -->
                    <div class="interview-main">
                        <div class="interview-header">
                            <div>
                                <span class="badge badge-primary" id="interview-mode-badge">Technical Interview</span>
                                <div>
                                    <span class="badge badge-primary" id="interview-mode-badge">Technical
                                        Interview</span>
                                    <!-- Navigation added below via JS -->
                                </div>
                            </div>
                            <div class="interview-timer">
                                <span>‚è±Ô∏è</span>
                                <span id="timer">02:00</span>
                            </div>
                        </div>

                        <div class="question-nav" id="question-nav">
                            <!-- Nav buttons injected by JS -->
                        </div>

                        <div class="interview-progress">
                            <div class="progress-bar" style="height: 4px;">
                                <div class="progress-fill" id="interview-progress" style="width: 10%;"></div>
                            </div>
                        </div>

                        <div class="interview-split-layout">
                            <!-- Left Panel: Question & Context -->
                            <div class="left-panel">
                                <div class="question-card">
                                    <div class="question-category" id="question-category">Data Structures</div>
                                    <h2 class="question-text" id="question-text">
                                        Explain the difference between a stack and a queue. When would you use each?
                                    </h2>
                                </div>

                                <div class="answer-tips">
                                    <span>üí° Tips:</span>
                                    <span>Be specific</span>
                                    <span>Use examples</span>
                                    <span>Structure your answer</span>
                                </div>
                            </div>

                            <!-- Right Panel: Input Area -->
                            <div class="right-panel">
                                <div class="answer-section">
                                    <div class="answer-header">
                                        <label style="font-size: 14px; font-weight: 500;" id="answer-label">Your
                                            Answer</label>
                                        <div class="answer-tools">
                                            <select id="language-select" class="language-select hidden">
                                                <option value="javascript">JavaScript</option>
                                                <option value="python">Python</option>
                                                <option value="java">Java</option>
                                                <option value="cpp">C++</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Text/Speech Input -->
                                    <div id="text-input-container"
                                        style="flex: 1; display: flex; flex-direction: column;">
                                        <textarea class="answer-input" id="answer-input"
                                            placeholder="Type your answer here or use the microphone... Be clear and structured in your response."></textarea>

                                        <!-- Real-time Speech Transcription Preview -->
                                        <div class="transcript-preview-container">
                                            <div class="transcript-label">
                                                <span>üé§ Live Transcription:</span>
                                            </div>
                                            <div class="transcript-preview" id="transcript-preview"></div>
                                        </div>

                                        <!-- Mic Button Below Transcript -->
                                        <div style="margin-top: 12px; display: flex; justify-content: center;">
                                            <button id="mic-btn" class="mic-btn" onclick="toggleSpeech()">
                                                <span class="mic-icon">üé§</span>
                                                <span id="mic-status">Start Speaking</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Code Editor Input (Monaco Integration) -->
                                    <div id="code-input-container" class="hidden"
                                        style="flex: 1; display: flex; flex-direction: column;">
                                        <div class="editor-container">
                                            <div class="editor-toolbar">
                                                <select class="lang-select" id="editor-lang-select"
                                                    onchange="window.EditorManager.setLanguage(this.value)">
                                                    <option value="javascript">JavaScript</option>
                                                    <option value="python">Python</option>
                                                    <option value="java">Java</option>
                                                </select>
                                                <button class="run-btn" onclick="window.EditorManager.run()">
                                                    ‚ñ∂ Run Code
                                                </button>
                                            </div>
                                            <div id="monaco-editor-host" class="monaco-editor-host"></div>
                                            <div class="editor-console">
                                                <div class="console-header">
                                                    <span>Output</span>
                                                    <span
                                                        onclick="document.getElementById('console-output').innerHTML=''"
                                                        style="cursor:pointer">Clear</span>
                                                </div>
                                                <div id="console-output" class="console-output"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="interview-actions">
                                    <button class="btn btn-secondary" onclick="skipQuestion()">
                                        Skip Question
                                    </button>
                                    <button class="btn btn-primary" onclick="submitAnswer()">
                                        Submit Answer ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Fixed Video Feed -->
                    <div class="video-container fixed-cam">
                        <video id="webcam-feed" autoplay playsinline muted></video>
                        <div class="video-overlay">
                            <div class="rec-indicator" id="rec-indicator">
                                <div class="rec-dot"></div> REC
                            </div>
                            <div class="video-label">Cam</div>
                        </div>
                    </div>

                    <!-- AI Interviewer (Hidden/Minimized for now) -->
                    <div class="ai-interviewer hidden" id="ai-interviewer"></div>
                </div>
            </div>

            <!-- Interview Complete -->
            <div id="complete-section" class="hidden" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 80px; margin-bottom: 24px;">üéâ</div>
                <h2 style="font-size: 32px; margin-bottom: 12px;">Interview Complete!</h2>
                <p class="text-muted" style="margin-bottom: 32px;">Great job! Your responses are being analyzed by AI.
                </p>
                <a href="skill-gap.html" class="btn btn-primary btn-lg">
                    View Skill Analysis ‚Üí
                </a>
            </div>

            <!-- Custom Modal for Alerts & Confirmations -->
            <div id="custom-modal" class="modal-overlay hidden">
                <div class="modal-container">
                    <div class="modal-icon" id="modal-icon">‚ö†Ô∏è</div>
                    <h3 class="modal-title" id="modal-title">Alert</h3>
                    <p class="modal-message" id="modal-message">This is a message</p>
                    <div class="modal-actions" id="modal-actions">
                        <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn-primary" id="modal-confirm">OK</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .interview-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .mode-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .mode-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .mode-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .mode-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .mode-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .interview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .interview-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(245, 158, 11, 0.15);
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .interview-progress {
            margin-bottom: 32px;
        }

        .interview-grid {
            display: block;
            max-width: 1400px;
            /* Wider for split screen */
            margin: 0 auto;
            height: calc(100vh - 140px);
        }

        .interview-split-layout {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 24px;
            height: 100%;
            overflow: hidden;
        }

        .left-panel {
            overflow-y: auto;
            padding-right: 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            overflow: hidden;
        }

        .question-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 0;
            /* Remove margin as it's in flex gap */
        }

        .answer-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin-bottom: 0;
        }

        .code-editor,
        .answer-input {
            flex: 1;
            min-height: 0;
            /* Allow flex shrink */
            margin-bottom: 16px;
        }

        #code-area,
        #answer-input {
            height: 100%;
        }

        .answer-tips {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .answer-tips span:first-child {
            color: var(--accent-gold);
        }

        .interview-grid {
            display: block;
            /* Single column */
            max-width: 900px;
            margin: 0 auto;
        }

        .question-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .nav-btn.completed {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .language-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            outline: none;
            cursor: pointer;
        }

        .language-select option {
            background: #1a1a1a;
        }

        .video-container.fixed-cam {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 220px;
            aspect-ratio: 16/9;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            background: black;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .video-container.fixed-cam:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .video-container.fixed-cam {
                width: 140px;
                top: 16px;
                right: 16px;
            }
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .mic-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            position: relative;
        }

        .mic-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .mic-btn.recording {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
            color: var(--accent-red);
            animation: pulse-red 2s infinite;
        }

        .mic-btn.recording .mic-icon {
            animation: pulse-scale 1s infinite;
        }

        @keyframes pulse-scale {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        #webcam-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Mirror effect */
        }

        .video-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rec-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .rec-indicator.active {
            opacity: 1;
        }

        .rec-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        .video-label {
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 6px;
            font-size: 11px;
            color: white;
        }

        .ai-interviewer {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 16px;
            position: relative;
        }

        .ai-pulse {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            opacity: 0;
        }

        .ai-status {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
                opacity: 0.8;
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
                opacity: 0;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
                opacity: 0;
            }
        }

        .ai-pulse.speaking {
            animation: pulse-blue 1.5s infinite;
            opacity: 1;
        }

        .interview-actions {
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .answer-tools {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .code-editor {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #333;
            font-family: 'Fira Code', monospace;
            min-height: 200px;
        }

        .code-area {
            width: 100%;
            height: 200px;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            outline: none;
        }

        /* Speech Transcription Preview */
        .transcript-preview-container {
            margin-top: 12px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            min-height: 50px;
            backdrop-filter: blur(8px);
            transition: all 0.3s;
        }

        .transcript-preview-container:has(.transcript-preview:not(:empty)) {
            background: rgba(99, 102, 241, 0.12);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
        }

        .transcript-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transcript-preview {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            font-style: italic;
            min-height: 20px;
            animation: fadeIn 0.2s;
        }

        .transcript-preview:empty::before {
            content: 'Click the mic button and start speaking to see your words appear here...';
            color: var(--text-muted);
            opacity: 0.6;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: modal-fade-in 0.2s ease;
        }

        @keyframes modal-fade-in {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }

            to {
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }

        .modal-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modal-slide-up 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modal-slide-up {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-icon {
            font-size: 56px;
            margin-bottom: 16px;
            animation: icon-bounce 0.5s ease;
        }

        @keyframes icon-bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .modal-message {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-actions .btn {
            min-width: 100px;
        }
    </style>

    <script>
        // Interview questions by mode
        const QUESTIONS = {
            mixed: [
                { type: 'code', category: 'Data Structures', text: 'Implement a function to check if a string is a palindrome.' },
                { type: 'text', category: 'Behavioral', text: 'Tell me about a time you had a conflict with a team member. How did you resolve it?' },
                { type: 'code', category: 'Algorithms', text: 'Write a function to find the first non-repeating character in a string.' },
                { type: 'text', category: 'System Design', text: 'How would you design a URL shortening service like bit.ly? Explain the key components.' },
                { type: 'code', category: 'JavaScript', text: 'Write a function that flattens a nested array of any depth.' },
                { type: 'text', category: 'Leadership', text: 'Describe a situation where you had to lead a project under tight deadlines.' },
                { type: 'code', category: 'Problem Solving', text: 'Given an array of integers, find two numbers that add up to a specific target.' },
                { type: 'text', category: 'Databases', text: 'Explain the difference between SQL and NoSQL databases. When would you choose one over the other?' }
            ]
        };

        const BOILERPLATES = {
            javascript: "// Write your solution here\nfunction solution() {\n    \n}",
            python: "# Write your solution here\ndef solution():\n    pass",
            java: "// Write your solution here\nclass Solution {\n    public void solve() {\n        \n    }\n}",
            cpp: "// Write your solution here\n#include <iostream>\n\nvoid solution() {\n    \n}"
        };

        let currentMode = 'mixed';
        let currentQuestionIndex = 0;
        let answers = [];
        let timerInterval = null;
        let timeLeft = 600; // 10 minutes global
        let initialTime = 600;
        let autoSaveInterval = null;

        // Load user data - Fixed to handle missing elements gracefully
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
            // Only update if elements exist (they're in sidebar.js)
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');
            const userRole = document.getElementById('user-role');

            if (userName && userData.name) {
                userName.textContent = userData.name;
            }
            if (userAvatar && userData.name) {
                userAvatar.textContent = userData.name.charAt(0).toUpperCase();
            }
            if (userRole && userData.targetRole) {
                const roleNames = {
                    'sde': 'Software Developer',
                    'frontend': 'Frontend Dev',
                    'backend': 'Backend Dev'
                };
                userRole.textContent = roleNames[userData.targetRole] || userData.targetRole;
            }

            // Auto-save answers every 10 seconds
            autoSaveInterval = setInterval(() => {
                if (answers.length > 0) {
                    localStorage.setItem('nextStep_interview_autosave', JSON.stringify({
                        mode: currentMode,
                        answers: answers,
                        currentIndex: currentQuestionIndex,
                        lastSaved: new Date().toISOString()
                    }));
                }
            }, 10000);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Don't trigger if user is typing in textarea or input
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

                if (e.key === 'Enter' && e.ctrlKey) {
                    submitAnswer();
                } else if (e.key === 'Escape') {
                    skipQuestion();
                }
            });

            // Language Select Listener
            const langSelect = document.getElementById('language-select');
            const editorLangSelect = document.getElementById('editor-lang-select');

            const handleLangChange = (lang) => {
                if (window.EditorManager) {
                    window.EditorManager.setLanguage(lang);
                    // Sync selectors
                    if (langSelect) langSelect.value = lang;
                    if (editorLangSelect) editorLangSelect.value = lang;

                    // Inject boilerplate if editor is empty or just has hello world
                    if (window.MonacoEditor) {
                        const currentVal = window.MonacoEditor.getValue();
                        if (!currentVal || currentVal.includes('Hello World')) {
                            const newCode = BOILERPLATES[lang];
                            if (newCode) window.MonacoEditor.setValue(newCode);
                        }
                    }
                }
            };

            if (langSelect) {
                langSelect.addEventListener('change', (e) => handleLangChange(e.target.value));
            }
            if (editorLangSelect) {
                editorLangSelect.addEventListener('change', (e) => handleLangChange(e.target.value));
            }
        });

        // Custom Modal Functions
        function showAlert(message, icon = '‚ö†Ô∏è', title = 'Alert') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-modal');
                const modalIcon = document.getElementById('modal-icon');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalActions = document.getElementById('modal-actions');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                // Set content
                modalIcon.textContent = icon;
                modalTitle.textContent = title;
                modalMessage.textContent = message;

                // Show only confirm button
                cancelBtn.classList.add('hidden');
                confirmBtn.textContent = 'OK';

                // Show modal
                modal.classList.remove('hidden');

                // Handle confirm
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(true);
                };

                confirmBtn.addEventListener('click', handleConfirm);
            });
        }

        function showConfirm(message, icon = '‚ùì', title = 'Confirm') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-modal');
                const modalIcon = document.getElementById('modal-icon');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalActions = document.getElementById('modal-actions');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                // Set content
                modalIcon.textContent = icon;
                modalTitle.textContent = title;
                modalMessage.textContent = message;

                // Show both buttons
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = 'OK';
                cancelBtn.textContent = 'Cancel';

                // Show modal
                modal.classList.remove('hidden');

                // Handle buttons
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }


        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft === 30) {
                    const timerEl = document.getElementById('timer');
                    if (timerEl) {
                        timerEl.style.color = '#ef4444';
                        timerEl.style.animation = 'pulse 1s infinite';
                    }
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showAlert('Time is up! Moving to next question...', '‚è∞', 'Time Expired').then(() => {
                        currentQuestionIndex++;
                        const questions = getQuestions();
                        if (currentQuestionIndex >= questions.length) {
                            completeInterview();
                        } else {
                            showQuestion();
                        }
                    });
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Reset color if time left > 30
            if (timeLeft > 30) {
                timerDisplay.style.color = 'var(--accent-gold)';
                timerDisplay.style.animation = 'none';
            }
        }

        // AI-generated questions storage
        let AI_QUESTIONS = null;

        async function startInterview(mode) {
            currentMode = mode;
            currentQuestionIndex = 0;
            answers = [];

            document.getElementById('mode-selection').classList.add('hidden');
            document.getElementById('interview-section').classList.remove('hidden');
            document.getElementById('interview-mode-badge').textContent = 'Adaptive Interview';

            // Try to generate AI questions based on resume
            const resumeData = JSON.parse(localStorage.getItem('nextStep_resume') || '{}');
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const userData = JSON.parse(localStorage.getItem('nextStep_user') || '{}');
            const targetRole = userProfile.targetRole || userData.targetRole || 'sde';

            if (window.GeminiService && window.GeminiService.isAvailable() && resumeData.skills) {
                try {
                    console.log('[Interview] Generating AI questions...');
                    const skills = [
                        ...(resumeData.skills.present || []),
                        ...(resumeData.skills.partial || [])
                    ];
                    AI_QUESTIONS = await window.GeminiService.generateQuestions(skills, targetRole, mode, 8);
                    console.log('[Interview] ‚úÖ AI generated', AI_QUESTIONS.length, 'questions');
                } catch (error) {
                    console.error('[Interview] AI failed:', error);
                    AI_QUESTIONS = null;
                }
            }

            // Use AI or fallback to static questions
            // Use AI or fallback to static questions
            const questions = AI_QUESTIONS || QUESTIONS[mode];

            // Generate Navigation
            const nav = document.getElementById('question-nav');
            nav.innerHTML = questions.map((_, i) => `
                <div class="nav-btn ${i === 0 ? 'active' : ''}" onclick="jumpToQuestion(${i})">
                    ${i + 1}
                </div>
            `).join('');

            showQuestion();
            startTimer(); // Global timer starts once


            // Initialize Media
            window.interviewMedia.initCamera('webcam-feed').then(success => {
                if (success) {
                    console.log("‚úÖ Camera initialized");
                    // Start Recording (Video + Audio)
                    const recordingStarted = window.interviewMedia.startVideoRecording();
                    if (recordingStarted) {
                        console.log("‚úÖ Video recording started");
                        document.getElementById('rec-indicator').classList.add('active');
                    } else {
                        console.error("‚ùå Video recording failed to start");
                        alert("Warning: Video recording could not start. Your interview will continue but won't be recorded.");
                    }
                } else {
                    console.warn("‚ùå Could not access camera");
                    alert("Please enable camera and microphone for the interview.");
                }
            }).catch(err => {
                console.error("Camera initialization error:", err);
            });

            // Initialize speech with real-time transcription preview
            window.interviewMedia.initSpeech((final, interim) => {
                const textArea = document.getElementById('answer-input');
                const transcriptPreview = document.getElementById('transcript-preview');

                // Only for text mode
                if (!document.getElementById('text-input-container').classList.contains('hidden')) {
                    // Update preview with interim results
                    if (interim) {
                        transcriptPreview.textContent = interim;
                        transcriptPreview.style.opacity = '0.6';
                    }

                    // Add final results to textarea
                    if (final) {
                        textArea.value += (textArea.value ? ' ' : '') + final;
                        textArea.scrollTop = textArea.scrollHeight;
                        transcriptPreview.textContent = '';
                    }
                }
            });
        }

        function toggleSpeech() {
            const isRecording = window.interviewMedia.toggleListening();
            const btn = document.getElementById('mic-btn');
            const status = document.getElementById('mic-status');
            const micIcon = btn.querySelector('.mic-icon');
            const aiStatus = document.getElementById('ai-status');

            if (isRecording) {
                // Started recording - Show AI Status
                btn.classList.add('recording');
                status.textContent = 'Stop Recording';
                micIcon.textContent = '‚èπÔ∏è'; // Stop icon
                if (aiStatus) {
                    aiStatus.classList.remove('hidden');
                    aiStatus.textContent = 'AI is listening...';
                }
            } else {
                // Stopped recording - Hide AI Status
                btn.classList.remove('recording');
                status.textContent = 'Start Speaking';
                micIcon.textContent = 'üé§'; // Mic icon
                if (aiStatus) {
                    aiStatus.classList.add('hidden');
                }

                // Clear transcript preview when stopped
                const transcriptPreview = document.getElementById('transcript-preview');
                if (transcriptPreview) {
                    transcriptPreview.textContent = '';
                }
            }
        }

        // Helper: Get current questions (AI or static)
        function getQuestions() {
            return AI_QUESTIONS || QUESTIONS[currentMode];
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            showQuestion();
        }

        function showQuestion() {
            const questions = getQuestions();
            const q = questions[currentQuestionIndex];

            // Update Nav
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === currentQuestionIndex);
                // Mark completed/skipped if in answers (simple check)
                if (answers.some(a => a.question === questions[i].text)) {
                    btn.classList.add('completed');
                }
            });
            document.getElementById('question-category').textContent = q.category;
            document.getElementById('question-text').textContent = q.text;

            // Speak the question
            const pulse = document.querySelector('.ai-pulse');
            window.interviewMedia.speak(q.text,
                () => pulse.classList.add('speaking'), // onStart
                () => pulse.classList.remove('speaking') // onEnd
            );

            // UI Toggle based on type
            const textContainer = document.getElementById('text-input-container');
            const codeContainer = document.getElementById('code-input-container');
            const micBtn = document.getElementById('mic-btn');
            const codeBadge = document.getElementById('code-lang-badge');
            const aiInterviewer = document.getElementById('ai-interviewer');

            if (q.type === 'code') {
                // Code Mode
                textContainer.classList.add('hidden');
                codeContainer.classList.remove('hidden');
                micBtn.classList.add('hidden');
                document.getElementById('language-select').classList.remove('hidden');
                document.getElementById('answer-label').textContent = 'Your Solution';
                aiInterviewer.classList.add('hidden'); // Hide AI for code questions
                aiInterviewer.classList.add('hidden'); // Hide AI for code questions

                // Initialize Editor if not already done (lazy load)
                if (window.EditorManager) {
                    // Sync top selector with editor selector
                    const topLangSelect = document.getElementById('language-select');
                    const editorLangSelect = document.getElementById('editor-lang-select');

                    setTimeout(() => {
                        window.EditorManager.init('monaco-editor-host');

                        // Map category to language
                        let lang = 'javascript';
                        const cat = q.category.toLowerCase();
                        if (cat.includes('python')) lang = 'python';
                        else if (cat.includes('java')) lang = 'java';
                        else if (cat.includes('c++')) lang = 'cpp';

                        window.EditorManager.setLanguage(lang);
                        if (topLangSelect) topLangSelect.value = lang;
                        if (editorLangSelect) editorLangSelect.value = lang;

                        // Inject custom boilerplate if first time
                        // Use safe check for MonacoEditor
                        const checkAndSet = () => {
                            if (window.MonacoEditor) {
                                if (!window.MonacoEditor.getValue() || window.MonacoEditor.getValue().includes('Hello World')) {
                                    const customBoilerplate = BOILERPLATES[lang];
                                    if (customBoilerplate) {
                                        window.MonacoEditor.setValue(customBoilerplate);
                                    }
                                }
                            } else {
                                setTimeout(checkAndSet, 50); // Retry if not ready
                            }
                        };
                        checkAndSet();
                    }, 100);
                }
            } else {
                // Text/Speech Mode
                textContainer.classList.remove('hidden');
                codeContainer.classList.add('hidden');
                micBtn.classList.remove('hidden');
                micBtn.classList.remove('hidden');
                document.getElementById('language-select').classList.add('hidden');
                document.getElementById('answer-label').textContent = 'Your Answer';
                aiInterviewer.classList.remove('hidden'); // Show AI for text questions
                document.getElementById('answer-input').value = ''; // Clear text

                // Clear transcript preview
                const transcriptPreview = document.getElementById('transcript-preview');
                if (transcriptPreview) {
                    transcriptPreview.textContent = '';
                }
            }

            document.getElementById('interview-progress').style.width =
                ((currentQuestionIndex + 1) / questions.length * 100) + '%';

            // Do NOT restart timer here as it's global
            // startTimer();
        }

        async function submitAnswer() {
            const questions = getQuestions();
            const q = questions[currentQuestionIndex];

            let answer = '';
            if (q.type === 'code') {
                answer = window.EditorManager ? window.EditorManager.getValue() : '';
            } else {
                answer = document.getElementById('answer-input').value.trim();
            }

            // Validate answer (allow skip with confirmation)
            if (!answer) {
                const confirmSkip = await showConfirm('Your answer is empty. Do you want to skip this question?', '‚ùì', 'Empty Answer');
                if (!confirmSkip) return;
            }

            // Visual feedback
            const submitBtn = document.querySelector('.interview-actions .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚úì Submitted';
            submitBtn.disabled = true;

            answers.push({
                question: q.text,
                category: q.category,
                type: q.type,
                answer: answer,
                timeSpent: initialTime - timeLeft // Fixed: Use initialTime
            });

            // Small delay for feedback
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                currentQuestionIndex++;

                if (currentQuestionIndex >= questions.length) {
                    completeInterview();
                } else {
                    showQuestion();
                }
            }, 500);
        }

        async function skipQuestion() {
            // Ask for confirmation before skipping
            const confirmSkip = await showConfirm('Are you sure you want to skip this question?', '‚è≠Ô∏è', 'Skip Question');
            if (!confirmSkip) return;

            const questions = getQuestions();
            const q = questions[currentQuestionIndex];

            // Fixed: Match format with submitAnswer
            answers.push({
                question: q.text,
                category: q.category,
                type: q.type,
                answer: '',
                skipped: true,
                timeSpent: initialTime - timeLeft
            });

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                completeInterview();
            } else {
                showQuestion();
            }
        }

        function completeInterview() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);

            // Stop media
            window.interviewMedia.stopListening();

            // Stop recording first, then camera
            console.log("üé¨ Stopping video recording...");
            window.interviewMedia.stopVideoRecording().then(videoUrl => {
                console.log("üìπ Video URL:", videoUrl);
                window.interviewMedia.stopCamera();

                if (videoUrl) {
                    console.log("‚úÖ Video recording completed successfully");
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = videoUrl;
                    downloadBtn.download = `nextstep-interview-${new Date().getTime()}.webm`;
                    downloadBtn.className = 'btn btn-secondary';
                    downloadBtn.style.marginTop = '16px';
                    downloadBtn.innerHTML = 'üì• Download Interview Recording';

                    const container = document.getElementById('complete-section');
                    if (!container.querySelector('a[download]')) {
                        container.appendChild(document.createElement('br'));
                        container.appendChild(downloadBtn);
                    }
                } else {
                    console.error("‚ùå No video URL returned - recording may have failed");
                }
            }).catch(err => {
                console.error("‚ùå Error stopping video recording:", err);
            });

            // Save interview results
            const interviewData = {
                mode: currentMode,
                answers: answers,
                completedAt: new Date().toISOString()
            };
            localStorage.setItem('nextStep_interview', JSON.stringify(interviewData));
            localStorage.removeItem('nextStep_interview_autosave'); // Clear autosave

            document.getElementById('interview-section').classList.add('hidden');
            document.getElementById('complete-section').classList.remove('hidden');
        }
    </script>
    <script src="js/interview-media.js"></script>

    <script src="js/sidebar.js"></script>
    <script src="js/click-spark.js"></script>
</body>

</html>